
<!DOCTYPE html>
<html lang="vi">
<head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>Ch·ªçn ch√≥ ch·ª•p ·∫£nh</title>

      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

      <style>
            body {
                  font-family: 'Comic Sans MS', cursive;
                  background: linear-gradient(to bottom, #fffafc, #ffeef5); /* Tr·∫Øng kem v√† h·ªìng nh·∫°t */
                  margin: 0;
                  padding: 20px 20px 100px;
                  text-align: center;
                  color: #4a3a41; /* N√¢u x√°m */
                  overflow-x: hidden;
            }
           
            .main-content > * {
                  opacity: 0;
                  transform: translateY(20px);
                  transition: opacity 0.8s ease-out, transform 0.8s ease-out;
            }

            .main-content.loaded > * {
                  opacity: 1;
                  transform: translateY(0);
            }

            .main-content.loaded > h1 { transition-delay: 0.1s; }
            .main-content.loaded > .top-buttons-container { transition-delay: 0.2s; }
            .main-content.loaded > .d-flex { transition-delay: 0.3s; }
            .main-content.loaded > div:nth-of-type(1) { transition-delay: 0.4s; }
            .main-content.loaded > div:nth-of-type(2) { transition-delay: 0.5s; }
            .main-content.loaded > div:nth-of-type(3) { transition-delay: 0.6s; }
            .main-content.loaded > #dog-list { transition-delay: 0.7s; }

            h1 {
                  font-size: 2.2em;
                  color: #a36173; /* H·ªìng ƒë·∫•t */
                  margin-bottom: 15px;
                  font-weight: bold;
            }

            #view-photos-btn {
                  display: inline-block;
                  margin-top: 10px;
                  padding: 10px 25px;
                  font-size: 1em;
                  font-weight: bold;
                  border-radius: 30px;
                  background-color: #f7a3b8; /* H·ªìng nh·∫°t */
                  color: #fff;
                  border: 2px solid #f7a3b8;
                  box-shadow: 0 4px 10px rgba(247, 163, 184, 0.4);
                  transition: all 0.3s ease;
                  text-decoration: none;
            }

            #view-photos-btn:hover {
                  background-color: #d86c8f; /* H·ªìng ƒë·∫≠m h∆°n */
                  border-color: #d86c8f;
                  color: white;
                  transform: scale(1.05);
            }

            .btn-view-photos, .btn-suggestion {
                  font-size: 1.3em;
                  font-weight: bold;
                  padding: 14px 32px;
                  border-radius: 30px;
                  background: linear-gradient(to right, #d86c8f, #a36173); /* Gradient h·ªìng ƒë·∫≠m */
                  color: white;
                  border: none;
                  box-shadow: 0 6px 15px rgba(216, 108, 143, 0.5);
                  transition: all 0.3s ease;
                  letter-spacing: 0.5px;
                  text-transform: none;
                  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            }

            .btn-view-photos i, .btn-suggestion i {
                  animation: bounceIcon 1.5s infinite;
            }

            .btn-view-photos:hover, .btn-suggestion:hover {
                  background: linear-gradient(to right, #a36173, #8a4e61);
                  transform: scale(1.05);
                  box-shadow: 0 8px 20px rgba(163, 97, 115, 0.6);
            }
            .btn-suggestion {
                  background: linear-gradient(to right, #4CAF50, #81C784);
                  padding: 10px 20px;
                  font-size: 1em;
            }
            .btn-suggestion:hover {
                  background: linear-gradient(to right, #388E3C, #66BB6A);
            }

            .btn-suggestion.disabled,
            .btn-view-photos.disabled,
            .dog-card.disabled {
                  opacity: 0.5;
                  pointer-events: none;
                  cursor: not-allowed;
            }


            @keyframes bounceIcon {
                  0%, 100% { transform: translateY(0); }
                  50% { transform: translateY(-4px); }
            }

            #search-input {
                  width: 90%;
                  max-width: 400px;
                  padding: 12px 20px;
                  font-size: 1em;
                  border-radius: 30px;
                  border: 2px solid #f7d8e2; /* H·ªìng r·∫•t nh·∫°t */
                  background-color: #fff0f7; /* H·ªìng nh·∫°t */
                  color: #4a3a41;
            }

            #seat-info {
                  margin-top: 10px;
                  font-weight: bold;
                  color: #4a3a41;
                  font-size: 1.1em;
            }

            #dog-list {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                  gap: 20px;
            }

            .dog-card {
                  background: #fff8fc; /* Tr·∫Øng kem */
                  padding: 10px;
                  border-radius: 20px;
                  box-shadow: 0 0 8px rgba(0,0,0,0.1);
                  position: relative;
                  overflow: hidden;
                  cursor: pointer;
            }

            .dog-card img {
                  width: 100%;
                  height: auto;
                  object-fit: contain;
                  border-radius: 15px;
            }

            .dog-card h3 {
                  margin: 5px 0;
                  color: #a36173;
            }
            .slide-section {
                  max-height: 0;
                  overflow: hidden;
                  transition: max-height 0.5s ease, padding 0.5s ease;
                  padding: 0;
            }

            .slide-section.show {
                  max-height: 300px;
                  padding: 20px 0;
            }

            .dog-card p {
                  margin: 0;
                  font-size: 0.85em;
                  color: #555;
            }

            .dog-card.selected {
                  border: 3px solid #d86c8f; /* H·ªìng ƒë·∫≠m h∆°n */
            }

            .dog-card.sleeping {
                  opacity: 0.8;
                  filter: grayscale(10%) blur(0.5px);
                  transition: 0.3s ease;
                  cursor: not-allowed;
            }

            .dog-card.sleeping::before {
                  content: "üí§ Kh√≤ kh√≤";
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  font-size: 1.4em;
                  font-weight: bold;
                  background: rgba(255, 255, 255, 0.8);
                  padding: 8px 15px;
                  border-radius: 20px;
                  color: #a36173;
                  font-family: 'Comic Sans MS', cursive;
                  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                  z-index: 3;
                  display: block;
            }

            .dog-card.sleeping.selected::before {
                  display: none;
            }

            .dog-image-wrapper {
                  background-size: contain;
                  background-repeat: no-repeat;
                  background-position: center;
                  overflow: visible;
            }

            .selected-overlay {
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%) scale(0.9);
                  background: rgba(255, 245, 250, 0.9); /* H·ªìng r·∫•t nh·∫°t */
                  color: #a36173;
                  padding: 10px 22px;
                  border-radius: 25px;
                  font-size: 1.1em;
                  font-weight: bold;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-family: 'Comic Sans MS', cursive;
                  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
                  opacity: 0;
                  transition: all 0.35s ease-in-out;
                  z-index: 2;
                  backdrop-filter: blur(2px);
            }

            .dog-card.selected .selected-overlay {
                  opacity: 1;
                  transform: translate(-50%, -50%) scale(1);
            }

            .selected-overlay i {
                  color: #d86c8f;
                  font-size: 1.3em;
                  margin-right: 8px;
            }

            .bottom-buttons-container {
                  position: fixed;
                  bottom: 20px;
                  left: 50%;
                  transform: translateX(-50%);
                  display: flex;
                  gap: 15px;
                  z-index: 1000;
            }

            #submit-btn {
                  background-color: #d86c8f;
                  color: white;
                  padding: 12px 30px;
                  border: none;
                  border-radius: 30px;
                  font-size: 1.2em;
                  cursor: pointer;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                  transition: background-color 0.3s, transform 0.3s;
                  display: none; /* ·∫®n n√∫t ban ƒë·∫ßu */
            }

            #submit-btn:hover {
                  background-color: #a36173;
                  transform: scale(1.05);
            }
            
            #requestStaffBtn {
                  font-size: 1.2em !important;
                  font-weight: bold !important;
                  padding: 12px 30px !important;
                  border-radius: 30px !important;
                  background: linear-gradient(to right, #4CAF50, #81C784) !important;
                  color: white !important;
                  border: none !important;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
                  transition: all 0.3s ease !important;
                  letter-spacing: 0.5px !important;
                  text-transform: none !important;
                  text-shadow: 1px 1px 3px rgba(0,0,0,0.3) !important;
            }

            #requestStaffBtn:hover {
                  background: linear-gradient(to right, #388E3C, #66BB6A) !important;
                  transform: scale(1.05) !important;
            }

            #selected-count {
                  position: fixed;
                  top: 20px;
                  right: 50%;
                  transform: translateX(50%);
                  background: #fff0f7;
                  color: #a36173;
                  padding: 10px 20px;
                  border-radius: 30px;
                  font-weight: bold;
                  display: none;
            }

            #alert-box-container {
                  position: fixed;
                  top: -100px;
                  left: 50%;
                  transform: translateX(-50%);
                  z-index: 9999;
                  width: 90%;
                  max-width: 400px;
                  text-align: center;
                  transition: top 0.5s ease, opacity 0.3s ease;
                  opacity: 0;
            }

            #alert-box-container.show {
                  top: 30px;
                  opacity: 1;
                  transform: translateX(-50%) scale(1.05);
            }

            #alert-box {
                  background: #fff8fc;
                  border: 2px solid #f7a3b8;
                  color: #a36173;
                  font-size: 1em;
                  font-weight: bold;
                  border-radius: 25px;
                  padding: 12px 20px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

            #photoOverlay {
                  position: fixed;
                  top: 0; left: 0;
                  width: 100vw; height: 100vh;
                  background: rgba(0, 0, 0, 0.85);
                  z-index: 99999;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: opacity 0.5s ease;
                  opacity: 1;
            }
            
            #photoOverlay.fade-out {
                  opacity: 0;
                  pointer-events: none;
            }

            #photoOverlay img {
                  height: 80vh;
                  object-fit: contain;
                  border-radius: 20px;
                  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            }

            .carousel-inner {
                  border-radius: 20px;
                  overflow: hidden;
            }
            .section-spacing {
                  margin-bottom: 30px;
            }

            #tapOverlayText {
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  font-size: 2em;
                  font-weight: bold;
                  color: white;
                  text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
                  opacity: 0.85;
                  z-index: 100001;
                  animation: pulseText 1.5s infinite;
                  pointer-events: none;
                  font-family: 'Comic Sans MS', cursive;
            }

            @keyframes pulseText {
                  0%, 100% { opacity: 0.85; }
                  50% { opacity: 0.4; }
            }

            .top-buttons-container {
                  margin-bottom: 20px;
            }
            
            /* Pop-up x√°c nh·∫≠n */
            #suggestionPopup {
                  position: fixed;
                  bottom: -150px; /* B·∫Øt ƒë·∫ßu t·ª´ d∆∞·ªõi m√†n h√¨nh */
                  left: 50%;
                  transform: translateX(-50%);
                  z-index: 9999;
                  width: 90%;
                  max-width: 400px;
                  background: #fff8fc;
                  border-radius: 20px;
                  padding: 20px;
                  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                  transition: bottom 0.5s ease;
            }
            #suggestionPopup.show-popup {
                  bottom: 20px;
            }
            .popup-message {
                  font-size: 1.1em;
                  font-weight: bold;
                  margin-bottom: 15px;
                  color: #a36173;
            }
            .popup-buttons {
                  display: flex;
                  justify-content: center;
                  gap: 10px;
            }
            .popup-buttons button {
                  padding: 10px 20px;
                  border-radius: 20px;
                  border: none;
                  font-weight: bold;
                  cursor: pointer;
            }
            .popup-buttons #confirmSuggestBtn {
                  background-color: #d86c8f;
                  color: white;
            }
            .popup-buttons #cancelSuggestBtn {
                  background-color: #f0f0f0;
                  color: #555;
            }
      </style>
</head>
<body>
<div id="photoOverlay">
      <div id="carouselPhotos" class="carousel slide w-100" style="max-width: 900px;" data-bs-ride="carousel" data-bs-interval="2500" data-bs-wrap="true">
            <div class="carousel-inner"></div>
      </div>
      <div id="tapOverlayText">Ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ ti·∫øp t·ª•c</div>
</div>

<div class="main-content">
      <h1>Ch·ªçn c√°c b√© iu ƒë·ªÉ ch·ª•p ·∫£nh</h1>
      <div class="top-buttons-container">
            <button id="requestStaffBtn">
                  <i class="fa-solid fa-bell me-2"></i>
                  <span>G·ªçi nh√¢n vi√™n</span>
            </button>
      </div>

      <div class="d-flex justify-content-center gap-3 section-spacing">
            <button id="toggleGuestInput" class="btn btn-view-photos">
                  <i class="fa-solid fa-image me-2"></i> Xem ·∫£nh kh√°ch
            </button>
            <button id="randomAlbumBtn" class="btn btn-view-photos" style="display: none; background: linear-gradient(to right, #f2c7d5, #d86c8f);">
                  <i class="fa-solid fa-shuffle me-2"></i> Xem album ng·∫´u nhi√™n
            </button>
      </div>

      <div id="guestLookupSection" class="slide-section text-center">
            <input type="text" id="guestNameInput" placeholder="Nh·∫≠p t√™n b·∫°n ƒë·ªÉ xem ·∫£nh"
                       style="padding: 10px 20px; border-radius: 30px; border: 2px solid #f7d8e2; background-color: #fff0f7; color: #4a3a41; max-width: 400px; width: 80%;" />
            <button onclick="xemAlbum()" style="margin-left: 10px; padding: 10px 25px; border-radius: 30px; background-color: #d86c8f; color: white; border: none; font-weight: bold;">
                  üîç T√¨m ·∫£nh
            </button>
            <p id="errorText" style="color: #c0392b; margin-top: 10px;"></p>

            <div id="qrContainer" class="slide-section">
                  <p>M√£ QR d·∫´n t·ªõi album c·ªßa b·∫°n:</p>
                  <div id="qrcode"></div>
            </div>
      </div>

      <div class="suggestion-container mt-4 mb-4">
            <h2 style="font-size: 1.5em; color: #a36173; font-weight: bold; margin-bottom: 15px;">Ho·∫∑c b·∫°n th√≠ch b√© c√∫n n√†o?</h2>
            <div class="d-flex justify-content-center flex-wrap gap-2">
                  <button class="btn btn-suggestion" data-suggestion="ch√¢n d√†i">Ch√¢n D√†i </button>
                  <button class="btn btn-suggestion" data-suggestion="tr·∫Øng tr·∫ªo">Tr·∫Øng Tr·∫ªo </button>
                  <button class="btn btn-suggestion" data-suggestion="m√∫p r·ª•p">M√∫p R·ª•p </button>
                  <button class="btn btn-suggestion" data-suggestion="da ngƒÉm">Da NgƒÉm </button>
            </div>
      </div>

      <div>
            <input type="text" id="search-input" placeholder="Nh·∫≠p t√™n, gi·ªëng ho·∫∑c t√≠nh c√°ch b√© c√∫n..." />
      </div>

      <ul id="suggestion-list" style="list-style: none; padding-left: 0; margin-top: 10px; text-align: left; max-width: 400px; margin-inline: auto;"></ul>

      <div id="seat-info">V·ªã tr√≠ ƒëang t·∫£i...</div>

      <div style="margin: 30px auto 20px; font-size: 1.1em; color: #a36173; font-weight: bold;">
            D∆∞·ªõi ƒë√¢y l√† danh s√°ch c√°c b√© c√∫n ƒëang ch·ªù ƒë∆∞·ª£c ch·ªçn n√®!
      </div>

      <div id="dog-list"></div>

      <div id="alert-box-container">
            <div id="alert-box" class="alert alert-success" role="alert">
                  <i class="fa-solid fa-circle-check me-2"></i>
                  <span id="alert-message">ƒê√£ g·ª≠i y√™u c·∫ßu!</span>
            </div>
      </div>

      <div class="bottom-buttons-container">
            <button id="submit-btn">
                  <i class="fa-solid fa-dog me-2"></i>
                  <span>Ch·ªët c√°c b√© iu üíñ</span>
            </button>
      </div>
</div>

<div id="selected-count">ƒê√£ ch·ªçn: 0 b√©</div>

<div class="modal fade" id="sleepModal" tabindex="-1" aria-labelledby="sleepModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px;">
                  <div class="modal-header" style="background-color: #f7a3b8;">
                        <h5 class="modal-title" id="sleepModalLabel">üí§ B√© ƒëang ng·ªß</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                  </div>
                  <div class="modal-body text-start" id="sleepModalBody">
                        </div>
                  <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Th√¥i ƒë·ªÉ b√© ngh·ªâ</button>
                        <button type="button" class="btn btn-pink" id="confirmSleepBtn" style="background-color: #d86c8f; color: white; display: none;">V·∫´n ch·ªçn b√©</button>
                  </div>
            </div>
      </div>
</div>

<div id="suggestionPopup">
      <div class="popup-message">B·∫°n c√≥ ch·∫Øc mu·ªën g·ª≠i y√™u c·∫ßu t√¨m b√© <span id="popupSuggestionText"></span> kh√¥ng?</div>
      <div class="popup-buttons">
            <button id="cancelSuggestBtn">H·ªßy</button>
            <button id="confirmSuggestBtn">X√°c nh·∫≠n</button>
      </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
      const firebaseConfig = {
            apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
            authDomain: "dogs-be72b.firebaseapp.com",
            databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
            projectId: "dogs-be72b",
            storageBucket: "dogs-be72b.appspot.com",
            messagingSenderId: "1003873040746",
            appId: "1:1003873040746:web:607f4ff587afc430d3cd13"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const dogList = document.getElementById("dog-list");
      const searchInput = document.getElementById("search-input");
      const submitBtn = document.getElementById("submit-btn");
      const requestStaffBtn = document.getElementById("requestStaffBtn");
      const selectedCount = document.getElementById("selected-count");
      const seatInfo = document.getElementById("seat-info");
      const alertMessage = document.getElementById("alert-message");
      const mainContent = document.querySelector(".main-content");
      const photoOverlay = document.getElementById("photoOverlay");

      let selectedDogs = [];
      let allDogs = [];
      let isPageLoaded = false;
      let lastAction = null; // null, 'dog_selected', 'suggestion_sent'

      const suggestionPopup = document.getElementById('suggestionPopup');
      const popupSuggestionText = document.getElementById('popupSuggestionText');
      const confirmSuggestBtn = document.getElementById('confirmSuggestBtn');
      const cancelSuggestBtn = document.getElementById('cancelSuggestBtn');

      function showBootstrapAlert(message, type = "success", duration = 3000) {
            const container = document.getElementById("alert-box-container");
            const alertBox = document.getElementById("alert-box");
            alertMessage.textContent = message;

            const colors = {
                  success: ["#fff8fc", "#f7a3b8", "#a36173"],
                  warning: ["#fef8e7", "#ffc107", "#b66f00"],
                  danger:   ["#ffe0e0", "#ff6b6b", "#c0392b"],
                  info: ["#e3f2fd", "#2196F3", "#1565C0"]
            };

            const [bg, border, color] = colors[type] || colors.success;
            alertBox.style.backgroundColor = bg;
            alertBox.style.borderColor = border;
            alertBox.style.color = color;

            container.classList.add("show");
            setTimeout(() => container.classList.remove("show"), duration);
      }

      function updateSelectedCount() {
            selectedCount.style.display = selectedDogs.length > 0 ? "block" : "none";
            selectedCount.textContent = `ƒê√£ ch·ªçn: ${selectedDogs.length} b√©`;
            submitBtn.style.display = selectedDogs.length > 0 ? "inline-block" : "none";

            // V√¥ hi·ªáu h√≥a n√∫t g·ª£i √Ω khi ƒë√£ ch·ªçn c√∫n
            if (selectedDogs.length > 0) {
                  lastAction = 'dog_selected';
                  document.querySelectorAll('.btn-suggestion').forEach(btn => btn.classList.add('disabled'));
            } else if (lastAction !== 'suggestion_sent') {
                  lastAction = null;
                  document.querySelectorAll('.btn-suggestion').forEach(btn => btn.classList.remove('disabled'));
            }
      }

      function getSeatFromHash() {
            const hash = window.location.hash.toLowerCase();
            const match = hash.match(/^#\/?([lr])(\d)$/);
            if (match) {
                  const side = match[1] === "r" ? "B√™n ph·∫£i" : "B√™n tr√°i";
                  const table = `B√†n ${match[2]}`;
                  return { side, table };
            }
            return null;
      }

      function updateSeatDisplay() {
            const seat = getSeatFromHash();
            seatInfo.textContent = seat
                  ? `V·ªã tr√≠ c·ªßa b·∫°n: ${seat.side} - ${seat.table}`
                  : "V·ªã tr√≠ ch∆∞a x√°c ƒë·ªãnh t·ª´ ƒë∆∞·ªùng link!";
      }

      function disableDogCards() {
            document.querySelectorAll('.dog-card').forEach(card => card.classList.add('disabled'));
            document.getElementById('search-input').disabled = true;
      }
      function enableDogCards() {
            document.querySelectorAll('.dog-card').forEach(card => card.classList.remove('disabled'));
            document.getElementById('search-input').disabled = false;
      }
      function disableSuggestionButtons() {
            document.querySelectorAll('.btn-suggestion').forEach(btn => btn.classList.add('disabled'));
      }
      function enableSuggestionButtons() {
            document.querySelectorAll('.btn-suggestion').forEach(btn => btn.classList.remove('disabled'));
      }

      function renderDogs(filter = "") {
            dogList.innerHTML = "";
            const keywords = filter.toLowerCase().split(/\s+/).filter(k => k);

            allDogs.filter(dog => {
                  const text = `${dog.name} ${dog.breed} ${dog.trait || dog.personality || ""}`.toLowerCase();
                  return keywords.every(k => text.includes(k));
            }).forEach(dog => {
                  const div = document.createElement("div");
                  div.className = "dog-card";
                  div.dataset.name = dog.name;
                  if (selectedDogs.includes(dog.name)) div.classList.add("selected");
                  if (dog.status !== "play") div.classList.add("sleeping");
                  if (lastAction === 'suggestion_sent') div.classList.add('disabled');

                  div.innerHTML = `
                        <div class="dog-image-wrapper">
                              <img src="${dog.image}" alt="${dog.name}" />
                              <div class="selected-overlay"><i class="fa-solid fa-check-circle me-2"></i> ƒê√£ ch·ªçn</div>
                        </div>
                        <h3>${dog.name}</h3>
                        <p>Gi·ªëng: ${dog.breed}</p>
                        <p>T√≠nh c√°ch: ${dog.trait || dog.personality || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
                  `;

                  div.addEventListener("click", () => {
                        if (lastAction === 'suggestion_sent') {
                            showBootstrapAlert("‚ùó B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu t√¨m b√© r·ªìi. Vui l√≤ng ƒë·ª£i nh√¢n vi√™n h·ªó tr·ª£ ho·∫∑c ƒë·ª£i 30 ph√∫t sau m·ªõi c√≥ th·ªÉ ch·ªçn c√∫n nh√©!", "warning");
                            return;
                        }

                        const dogName = dog.name;

                        if (dog.status !== "play") {
                              showBootstrapAlert(`üò¥ B√© ${dogName} ƒëang ngh·ªâ ng∆°i v√† l√†m ·ªü ca kh√°c, b·∫°n vui l√≤ng ch·ªçn b√© ƒëang th·ª©c nha!`, "warning");
                              return;
                        }

                        if (selectedDogs.includes(dogName)) {
                              selectedDogs = selectedDogs.filter(n => n !== dogName);
                              div.classList.remove("selected");
                              updateSelectedCount();
                              return;
                        }

                        if (selectedDogs.length >= 3) {
                              showBootstrapAlert("üêæ B·∫°n ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 3 b√© nha!", "warning");
                              return;
                        }

                        selectedDogs.push(dogName);
                        div.classList.add("selected");
                        updateSelectedCount();
                  });

                  dogList.appendChild(div);
            });
      }

      function resetState() {
          lastAction = null;
          selectedDogs = [];
          updateSelectedCount();
          enableSuggestionButtons();
          enableDogCards();
      }

      db.ref("dogs").on("value", snapshot => {
            const data = snapshot.val();
            allDogs = Object.values(data || {}).sort((a, b) => {
                  if (a.status === "play" && b.status !== "play") return -1;
                  if (a.status !== "play" && b.status === "play") return 1;
                  return a.name.localeCompare(b.name);
            });
            renderDogs(searchInput.value);
      });

      searchInput.addEventListener("input", () => renderDogs(searchInput.value));
      window.addEventListener("hashchange", updateSeatDisplay);
      window.addEventListener("DOMContentLoaded", updateSeatDisplay);

      submitBtn.addEventListener("click", () => {
            const todayStr = new Date().toISOString().split("T")[0];
            const lastSelectDate = localStorage.getItem("lastSelectDate");

            if (lastSelectDate === todayStr) {
                  showBootstrapAlert("üìÖ B·∫°n ƒë√£ ch·ªët r·ªìi trong h√¥m nay. H·∫πn g·∫∑p l·∫°i b·∫°n v√†o ng√†y mai nh√©!", "warning", 5000);
                  return;
            }

            db.ref("lastSelectTime").once("value").then(snapshot => {
                  const lastTimestamp = snapshot.val();
                  const now = Date.now();
                  const cooldown = 1800000;
                  if (lastTimestamp && now - lastTimestamp < cooldown) {
                        const wait = (cooldown - (now - lastTimestamp)) / 1000;
                        const min = Math.floor(wait / 60);
                        const sec = Math.floor(wait % 60);
                        const msg = `‚è≥ Vui l√≤ng quay l·∫°i sau ${min} ph√∫t ${sec} gi√¢y nha!`;
                        showBootstrapAlert(msg, "warning");
                        return;
                  }

                  const seat = getSeatFromHash() || { side: "?", table: "?" };
                  if (selectedDogs.length === 0) {
                        showBootstrapAlert("‚ùó B·∫°n ch∆∞a ch·ªçn b√© c√∫n n√†o c·∫£!", "danger");
                        return;
                  }

                  const nowDate = new Date();
                  const timeStr = `${nowDate.getHours()}h${nowDate.getMinutes()}p`;
                  const awake = [], sleep = [];

                  selectedDogs.forEach(name => {
                        const dog = allDogs.find(d => d.name === name);
                        if (!dog) return;
                        (dog.status === "play" ? awake : sleep).push(name);
                  });

                  let msg = `‚è∞ Th·ªùi gian: ${timeStr}\nüìç V·ªã tr√≠: ${seat.side} - ${seat.table}\n`;
                  if (awake.length > 0) msg += `üê∂ B√© ƒëang ch∆°i: ${awake.join(", ")}\n`;
                  if (sleep.length > 0) msg += `üò¥ B√© ƒëang ng·ªß (kh√°ch v·∫´n mu·ªën order): ${sleep.join(", ")}`;

                  db.ref("photoRequests").push({ selectedDogs, time: timeStr, seat })
                        .then(() => {
                              db.ref("lastSelectTime").set(firebase.database.ServerValue.TIMESTAMP);
                              localStorage.setItem("lastSelectDate", todayStr);

                              showBootstrapAlert(`üéâ B·∫°n ƒë√£ ch·ªët: ${selectedDogs.join(", ")}`, "success", 5000);
                              resetState(); // Reset tr·∫°ng th√°i
                              renderDogs(searchInput.value);

                              const encodedMsg = encodeURIComponent(msg);
                              fetch(`https://api.telegram.org/bot7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI/sendMessage?chat_id=-4831972836&text=${encodedMsg}`);
                        });
            });
      });

      requestStaffBtn.addEventListener("click", () => {
            const seat = getSeatFromHash() || { side: "?", table: "?" };
            const msg = `üîîüîîüîî Kh√°ch h√†ng t·∫°i v·ªã tr√≠ ${seat.side} - ${seat.table} c·∫ßn h·ªó tr·ª£! Vui l√≤ng t·ªõi b√†n ngay.`;
            const encodedMsg = encodeURIComponent(msg);
            
            fetch(`https://api.telegram.org/bot7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI/sendMessage?chat_id=-4831972836&text=${encodedMsg}`)
                  .then(response => {
                        if (response.ok) {
                              showBootstrapAlert("Nh√¢n vi√™n s·∫Ω ƒë·∫øn ngay! Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t. üíñ", "info", 5000);
                        } else {
                              showBootstrapAlert("‚ö†Ô∏è L·ªói: Kh√¥ng g·ª≠i ƒë∆∞·ª£c y√™u c·∫ßu, vui l√≤ng th·ª≠ l·∫°i!", "danger");
                        }
                  })
                  .catch(() => {
                        showBootstrapAlert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i!", "danger");
                  });
      });

      let currentSuggestion = null;
      document.querySelectorAll('.btn-suggestion').forEach(button => {
            button.addEventListener('click', () => {
                if (lastAction === 'dog_selected') {
                    showBootstrapAlert("‚ùó B·∫°n ƒë√£ ch·ªçn c√∫n r·ªìi. Vui l√≤ng ch·ªët c√°c b√© ho·∫∑c ƒë·ª£i 30 ph√∫t sau ƒë·ªÉ g·ª≠i y√™u c·∫ßu t√¨m b√© kh√°c nh√©!", "warning");
                    return;
                }

                currentSuggestion = button.dataset.suggestion;
                popupSuggestionText.textContent = `"${currentSuggestion}"`;
                suggestionPopup.classList.add('show-popup');
            });
      });

      confirmSuggestBtn.addEventListener('click', () => {
          suggestionPopup.classList.remove('show-popup');
          const suggestion = currentSuggestion;
          const seat = getSeatFromHash() || { side: "?", table: "?" };
          const cooldown = 1800000;
          const now = Date.now();
          const lastSuggestionTime = localStorage.getItem("lastSuggestionTime");

          if (lastSuggestionTime && (now - parseInt(lastSuggestionTime, 10) < cooldown)) {
                const wait = (cooldown - (now - lastSuggestionTime)) / 1000;
                const min = Math.floor(wait / 60);
                const sec = Math.floor(wait % 60);
                showBootstrapAlert(`‚è≥ Vui l√≤ng ƒë·ª£i ${min} ph√∫t ${sec} gi√¢y tr∆∞·ªõc khi g·ª≠i y√™u c·∫ßu t√¨m b√© kh√°c!`, "warning", 5000);
                return;
          }

          const msg = `üì¢ Kh√°ch h√†ng t·∫°i v·ªã tr√≠ ${seat.side} - ${seat.table} mu·ªën t√¨m b√© c√∫n c√≥ ƒë·∫∑c ƒëi·ªÉm: ${suggestion}.`;
          const encodedMsg = encodeURIComponent(msg);

          fetch(`https://api.telegram.org/bot7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI/sendMessage?chat_id=-4831972836&text=${encodedMsg}`)
                .then(response => {
                      if (response.ok) {
                            localStorage.setItem("lastSuggestionTime", now.toString());
                            lastAction = 'suggestion_sent';
                            disableDogCards();
                            showBootstrapAlert(`Y√™u c·∫ßu t√¨m b√© ${suggestion} c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i.`, "success");
                      } else {
                            showBootstrapAlert("‚ö†Ô∏è L·ªói: Kh√¥ng g·ª≠i ƒë∆∞·ª£c y√™u c·∫ßu, vui l√≤ng th·ª≠ l·∫°i!", "danger");
                      }
                })
                .catch(() => {
                      showBootstrapAlert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i!", "danger");
                });
      });

      cancelSuggestBtn.addEventListener('click', () => {
          suggestionPopup.classList.remove('show-popup');
      });

      const photoUrls = [
            "image/slide9.jpg", "image/slide6.jpg", "image/slide2.jpg",
            "image/slide3.jpg", "image/slide4.jpg", "image/slide5.jpg"
      ];
      const carouselInner = document.querySelector("#carouselPhotos .carousel-inner");

      photoUrls.forEach((url, idx) => {
            const div = document.createElement("div");
            div.className = "carousel-item" + (idx === 0 ? " active" : "");
            div.innerHTML = `<img src="${url}" class="d-block w-100" alt="·∫¢nh ch·ª•p">`;
            carouselInner.appendChild(div);
      });
      
      photoOverlay.addEventListener("click", () => {
            if (isPageLoaded) return;
            document.getElementById("tapOverlayText")?.remove();
            photoOverlay.classList.add("fade-out");
            setTimeout(() => {
                  photoOverlay.style.display = 'none';
                  mainContent.classList.add('loaded');
                  isPageLoaded = true;
            }, 500);
      });
      
      const isMaintenance = false;

      if (isMaintenance) {
            document.body.innerHTML = `
                  <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#fffafc;text-align:center;font-family:'Comic Sans MS', cursive;">
                        <div>
                              <h1 style="color:#a36173;font-size:2em;">üöß Trang ƒëang b·∫£o tr√¨</h1>
                              <p style="color:#4a3a41;">Cherry Pet Coffee ƒëang c·∫≠p nh·∫≠t ƒë·ªÉ ph·ª•c v·ª• b·∫°n t·ªët h∆°n.<br>Vui l√≤ng quay l·∫°i sau nh√©! üê∂üíï</p>
                        </div>
                  </div>
            `;
      }
      function normalizeName(input) {
      return input
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-zA-Z0-9]/g, "")
            .toLowerCase();
      }

      function xemAlbum() {
      const rawInput = document.getElementById("guestNameInput").value;
      const name = normalizeName(rawInput);
            const errorText = document.getElementById("errorText");

            if (!name) {
                  errorText.innerText = "‚ùó Vui l√≤ng nh·∫≠p t√™n!";
                  return;
            }

            db.ref("anhKhach/" + name).once("value").then(snapshot => {
                  const data = snapshot.val();
                  if (data) {
                        const url = `https://thanhchan791791.github.io/hihihi/khoanh/?name=${encodeURIComponent(name)}`;
                        window.location.href = url;
                  } else {
                        errorText.innerText = "‚ùå Kh√¥ng t√¨m th·∫•y t√™n trong h·ªá th·ªëng!";
                  }
            }).catch(() => {
                  errorText.innerText = "‚ö†Ô∏è C√≥ l·ªói k·∫øt n·ªëi!";
            });
      }

      document.getElementById("toggleGuestInput").addEventListener("click", () => {
            const guestSection = document.getElementById("guestLookupSection");
            const randomBtn = document.getElementById("randomAlbumBtn");

            guestSection.classList.toggle("show");
            randomBtn.style.display = guestSection.classList.contains("show") ? "inline-block" : "none";

            if (guestSection.classList.contains("show")) {
                  setTimeout(() => {
                        guestSection.scrollIntoView({ behavior: "smooth", block: "center" });
                  }, 300);
            }
      });

      document.getElementById("randomAlbumBtn").addEventListener("click", () => {
            db.ref("anhKhach").once("value").then(snapshot => {
                  const data = snapshot.val();
                  const names = Object.keys(data || {});
                  if (names.length === 0) {
                        showBootstrapAlert("‚ùå Kh√¥ng c√≥ ·∫£nh kh√°ch n√†o!", "warning");
                        return;
                  }

                  const randomName = names[Math.floor(Math.random() * names.length)];
                  const url = `https://thanhchan791791.github.io/hihihi/khoanh/?name=${encodeURIComponent(randomName)}`;
                  window.location.href = url;
            }).catch(() => {
                  showBootstrapAlert("‚ö†Ô∏è C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu ·∫£nh kh√°ch!", "danger");
            });
      });
</script>
</body>
</html>
