<!DOCTYPE html>
<html lang="vi">
<head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>Gợi Ý Chó Cưng</title>

      <link rel="icon" href="logocherry.png" type="image/png" /> 

      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

      <style>
            :root {
                  --primary-color: #a36173; /* Hồng đất */
                  --secondary-color: #d86c8f; /* Hồng đậm */
                  --light-bg: #fff8fc; /* Trắng kem */
                  --dark-text: #4a3a41; /* Nâu xám */
                  --transition-speed: 0.35s;
            }

            body {
                  font-family: 'Comic Sans MS', cursive;
                  background: linear-gradient(to bottom, #fffafc, #ffeef5);
                  margin: 0;
                  padding: 40px 20px;
                  text-align: center;
                  color: var(--dark-text);
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  min-height: 100vh;
            }
           
            h1 {
                  font-size: 2.2em;
                  color: var(--primary-color);
                  margin-bottom: 30px;
                  font-weight: bold;
            }
            
            /* --- LOGO STYLING --- */
            .logo-container {
                  margin-bottom: 20px;
            }

            .logo-container img {
                  width: 100%;
                  max-width: 150px; 
                  height: auto;
                  border-radius: 50%; 
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                  border: 4px solid var(--light-bg);
            }

            .suggestion-container {
                  width: 100%;
                  max-width: 600px;
                  background: var(--light-bg);
                  padding: 30px 20px;
                  border-radius: 20px;
                  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                  position: relative;
                  overflow: hidden; 
                  margin-bottom: 40px; 
            }

            /* --- Toggle Switch Styling --- */
            .toggle-container {
                  display: inline-flex;
                  background-color: #e9e9e9;
                  border-radius: 12px;
                  margin-bottom: 25px;
                  padding: 4px;
                  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            }

            .toggle-btn {
                  padding: 8px 18px;
                  border: none;
                  border-radius: 8px;
                  font-weight: bold;
                  cursor: pointer;
                  background-color: transparent;
                  color: var(--dark-text);
                  transition: all var(--transition-speed) ease-in-out;
                  position: relative;
                  z-index: 1;
            }

            .toggle-btn.active {
                  color: white;
                  background-color: var(--secondary-color);
                  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            }

            /* --- Suggestion Content Transition --- */
            .suggestion-wrapper {
                  display: flex;
                  transition: transform var(--transition-speed) ease-in-out;
            }

            .suggestion-section {
                  flex-shrink: 0;
                  width: 100%;
                  transition: opacity var(--transition-speed) ease-in-out;
                  padding-top: 10px;
            }
            
            .suggestion-wrapper.show-personality {
                  transform: translateX(-100%);
            }

            /* --- Suggestion Buttons --- */
            .btn-suggestion {
                  font-size: 1.05em;
                  font-weight: bold;
                  padding: 12px 22px;
                  border-radius: 30px;
                  background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
                  color: white;
                  border: none;
                  box-shadow: 0 4px 10px rgba(216, 108, 143, 0.4);
                  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
                  margin: 5px;
                  min-width: 110px;
            }

            .btn-suggestion:hover {
                  background: linear-gradient(to right, var(--primary-color), #8a4e61);
                  transform: translateY(-2px);
                  box-shadow: 0 6px 15px rgba(163, 97, 115, 0.6);
            }

            .btn-suggestion:active {
                  transform: scale(0.95);
                  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }
            
            /* --- Breed Filter Buttons --- */
            .btn-filter {
                  font-size: 0.9em;
                  font-weight: 500;
                  padding: 8px 15px;
                  border-radius: 20px;
                  background-color: #fff0f5; /* Màu nền nhẹ */
                  color: var(--dark-text);
                  border: 1px solid var(--primary-color);
                  transition: all 0.2s; 
                  margin: 5px;
            }

            .btn-filter.active {
                  background-color: var(--primary-color);
                  color: white;
                  border-color: var(--primary-color);
                  font-weight: bold;
            }

            .btn-filter:hover:not(.active) {
                  background-color: #fce7ef;
                  transform: translateY(-1px);
            }

            /* --- Other Elements --- */
            #seat-info {
                  margin-top: 20px;
                  font-weight: bold;
                  color: var(--dark-text);
                  font-size: 1.1em;
            }

            /* Pop-up xác nhận */
            #suggestionPopup {
                  position: fixed;
                  bottom: -150px;
                  left: 50%;
                  transform: translateX(-50%);
                  z-index: 9999;
                  width: 90%;
                  max-width: 400px;
                  background: var(--light-bg);
                  border-radius: 20px;
                  padding: 20px;
                  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                  transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            }
            #suggestionPopup.show-popup {
                  bottom: 20px;
            }
            .popup-message {
                  font-size: 1.1em;
                  font-weight: bold;
                  margin-bottom: 15px;
                  color: var(--primary-color);
            }
            .popup-buttons {
                  display: flex;
                  justify-content: center;
                  gap: 10px;
            }
            .popup-buttons button {
                  padding: 10px 20px;
                  border-radius: 20px;
                  border: none;
                  font-weight: bold;
                  cursor: pointer;
                  transition: transform 0.2s;
            }
            .popup-buttons #confirmSuggestBtn {
                  background-color: var(--secondary-color);
                  color: white;
            }
            .popup-buttons #cancelSuggestBtn {
                  background-color: #f0f0f0;
                  color: #555;
            }

            /* --- Alert Box --- */
            #alert-box-container {
                  position: fixed;
                  top: -100px;
                  left: 50%;
                  transform: translateX(-50%);
                  z-index: 9999;
                  width: 90%;
                  max-width: 400px;
                  text-align: center;
                  transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
                  opacity: 0; 
            }

            #alert-box-container.show {
                  top: 30px;
                  opacity: 1;
                  transform: translateX(-50%) scale(1);
            }

            #alert-box {
                  background: var(--light-bg);
                  border: 2px solid #f7a3b8;
                  color: var(--primary-color);
                  font-size: 1em;
                  font-weight: bold;
                  border-radius: 25px;
                  padding: 12px 20px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            /* --- DOG LIST STYLING --- */
            #dogListTitle {
                  font-size: 1.8em;
                  color: var(--secondary-color);
                  margin: 50px 0 15px 0; /* Giảm margin-bottom để chèn filter */
                  font-weight: bold;
                  width: 100%;
            }
            
            #dogFilterContainer { /* Thêm CSS cho Filter Container */
                  margin-bottom: 30px;
                  width: 100%;
                  max-width: 600px;
                  display: flex;
                  flex-wrap: wrap;
                  justify-content: center;
            }

            .dog-card {
                  background: white;
                  border-radius: 15px;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                  padding: 15px;
                  margin-bottom: 20px;
                  transition: transform 0.3s;
                  border: 1px solid #f0f0f0;
                  cursor: pointer;
            }

            .dog-card:hover {
                  transform: translateY(-3px);
                  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            }

            .dog-image {
                  width: 100%;
                  height: 200px; 
                  object-fit: cover;
                  border-radius: 10px;
                  margin-bottom: 15px;
                  border: 3px solid var(--light-bg);
            }

            .dog-name {
                  font-size: 1.4em;
                  font-weight: bold;
                  color: var(--primary-color);
                  margin-bottom: 5px;
            }

            .dog-breed {
                  font-size: 1em;
                  color: var(--dark-text);
                  opacity: 0.8;
            }
            
            /* --- DOG DETAIL POPUP --- */
            #dogDetailPopup {
                  position: fixed;
                  top: -150%; 
                  left: 50%;
                  transform: translate(-50%, -50%);
                  z-index: 10000; 
                  width: 90%;
                  max-width: 450px;
                  background: white;
                  border-radius: 20px;
                  padding: 25px;
                  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                  opacity: 0;
                  transition: top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s ease-in-out; 
            }
            #dogDetailPopup.show-detail-popup {
                  top: 50%; 
                  opacity: 1;
            }

            #closeDetailPopupBtn {
                  position: absolute;
                  top: 10px;
                  right: 15px;
                  background: none;
                  border: none;
                  font-size: 1.8em;
                  font-weight: bold;
                  color: var(--primary-color);
                  cursor: pointer;
                  line-height: 1;
            }

            #dogDetailContent img {
                  width: 100%;
                  height: 250px;
                  object-fit: cover;
                  border-radius: 15px;
                  margin-bottom: 15px;
                  border: 5px solid var(--light-bg);
                  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .detail-name {
                  font-size: 1.8em;
                  font-weight: bold;
                  color: var(--secondary-color);
                  margin-bottom: 10px;
            }

            .detail-info {
                  text-align: left;
                  padding: 0 15px;
            }
            .detail-info p {
                  margin: 5px 0;
                  font-size: 1.1em;
                  padding: 8px 0;
                  border-bottom: 1px dashed #f0f0f0;
            }
            .detail-info p:last-child {
                  border-bottom: none;
            }

            .detail-info strong {
                  color: var(--primary-color);
                  min-width: 110px;
                  display: inline-block;
                  font-weight: 600;
            }
      </style>
</head>
<body>
      
      <div class="logo-container">
            <img src="logocherry.png" alt="Logo Quán" />
      </div>

      <h1>Chọn đặc điểm cún cưng bạn muốn ôm hoặc chụp ảnh</h1>

      <div class="suggestion-container">
            <h2 style="font-size: 1.5em; color: var(--primary-color); font-weight: bold; margin-bottom: 20px;">Lựa chọn theo</h2>
            
            <div class="toggle-container">
                  <button class="toggle-btn active" id="toggleAppearance">Ngoại hình</button>
                  <button class="toggle-btn" id="togglePersonality">Tính cách</button>
            </div>
            
            <p style="margin-bottom: 25px; color: var(--dark-text); font-size: 0.9em;">Nhấn vào gợi ý để gửi yêu cầu đến nhân viên.</p>

            <div class="suggestion-wrapper" id="suggestionWrapper">
                  
                  <div class="suggestion-section" id="appearanceSection">
                        <div class="d-flex justify-content-center flex-wrap gap-3">
                              <button class="btn btn-suggestion" data-suggestion="chân dài" data-type="appearance">Chân Dài <i class="fa-solid fa-paw"></i></button>
                              <button class="btn btn-suggestion" data-suggestion="chân ngắn" data-type="appearance">Chân Ngắn <i class="fa-solid fa-dog"></i></button>
                              <button class="btn btn-suggestion" data-suggestion="ú nu" data-type="appearance">Ú Nu <i class="fa-solid fa-heart"></i></button>
                              <button class="btn btn-suggestion" data-suggestion="dễ thương" data-type="appearance">Dễ Thương <i class="fa-solid fa-face-grin-hearts"></i></button>
                              <button class="btn btn-suggestion" data-suggestion="trắng trẻo" data-type="appearance">Trắng Trẻo <i class="fa-solid fa-star"></i></button>
                        </div>
                  </div>

                  <div class="suggestion-section" id="personalitySection">
                        <div class="d-flex justify-content-center flex-wrap gap-3">
                              <button class="btn btn-suggestion" data-suggestion="ngoan hiền" data-type="personality">Ngoan, Hiền <i class="fa-solid fa-thumbs-up"></i></button>
                              <button class="btn btn-suggestion" data-suggestion="quậy phá" data-type="personality">Quậy Phá <i class="fa-solid fa-bomb"></i></button>
                              <button class="btn btn-suggestion" data-suggestion="quấn khách" data-type="personality">Quấn Khách <i class="fa-solid fa-hand-holding-heart"></i></button>
                              <button class="btn btn-suggestion" data-suggestion="khó chịu" data-type="personality">Khó Chịu <i class="fa-solid fa-face-angry"></i></button>
                        </div>
                  </div>

            </div> </div>

      <div id="seat-info">Vị trí đang tải...</div>
      
      <button id="showDogsBtn" class="btn btn-suggestion" style="margin-bottom: 40px; min-width: 200px;">Tất cả Cún Cưng</button>

      <div id="alert-box-container">
            <div id="alert-box" class="alert alert-success" role="alert">
                  <i class="fa-solid fa-circle-check me-2"></i>
                  <span id="alert-message">Đã gửi yêu cầu!</span>
            </div>
      </div>

      <div id="suggestionPopup">
            <div class="popup-message">Bạn có chắc muốn gửi yêu cầu tìm bé có đặc điểm <span id="popupSuggestionText" style="color: var(--secondary-color);"></span> không?</div>
            <div class="popup-buttons">
                  <button id="cancelSuggestBtn">Hủy</button>
                  <button id="confirmSuggestBtn">Xác nhận</button>
            </div>
      </div>

      <div id="dogDetailPopup">
            <button id="closeDetailPopupBtn" aria-label="Đóng">&times;</button>
            <div id="dogDetailContent">
                  </div>
      </div>

      <h2 id="dogListTitle" style="display: none;">Danh sách cún cưng hiện tại</h2>
      
      <div id="dogFilterContainer" style="display: none;">
            <button class="btn btn-filter active" data-breed-filter="all">Tất cả</button>
            <button class="btn btn-filter" data-breed-filter="samoyed">Samoyed</button>
            <button class="btn btn-filter" data-breed-filter="husky">Husky</button>
            <button class="btn btn-filter" data-breed-filter="golden">Golden</button>
            <button class="btn btn-filter" data-breed-filter="alaska">Alaska</button>
            <button class="btn btn-filter" data-breed-filter="corgi">Corgi</button>
            <button class="btn btn-filter" data-breed-filter="poodle">Poodle</button>
      </div>

      <div id="dogListContainer" class="container" style="display: none;">
            <div class="row row-cols-2 row-cols-md-3 g-3">
                  <p id="loadingMessage">Đang tải danh sách cún cưng...</p>
            </div>
      </div>
      
      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

      <script>
            const firebaseConfig = {
                  apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
                  authDomain: "dogs-be72b.firebaseapp.com",
                  databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
                  projectId: "dogs-be72b",
                  storageBucket: "dogs-be72b.appspot.com",
                  messagingSenderId: "1003873040746",
                  appId: "1:1003873040746:web:607f4ff587afc430d3cd13"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database(); 

            // DOM Elements
            const suggestionPopup = document.getElementById('suggestionPopup');
            const popupSuggestionText = document.getElementById('popupSuggestionText');
            const confirmSuggestBtn = document.getElementById('confirmSuggestBtn');
            const cancelSuggestBtn = document.getElementById('cancelSuggestBtn');
            const seatInfo = document.getElementById("seat-info");
            const alertMessage = document.getElementById("alert-message");
            const suggestionWrapper = document.getElementById('suggestionWrapper');
            const toggleAppearance = document.getElementById('toggleAppearance');
            const togglePersonality = document.getElementById('togglePersonality');
            
            // Elements MỚI/CẦN THAM CHIẾU
            const dogListContainerDiv = document.getElementById('dogListContainer'); // To show/hide the whole container
            const dogListContainerRow = document.querySelector('#dogListContainer .row'); // To append cards
            const dogListTitle = document.getElementById('dogListTitle');
            const showDogsBtn = document.getElementById('showDogsBtn'); // Nút mới
            
            const dogDetailPopup = document.getElementById('dogDetailPopup');
            const dogDetailContent = document.getElementById('dogDetailContent');
            const closeDetailPopupBtn = document.getElementById('closeDetailPopupBtn');
            
            // ELEMENTS VÀ BIẾN MỚI CHO CHỨC NĂNG LỌC
            const dogFilterContainer = document.getElementById('dogFilterContainer');
            let currentFilterBreed = 'all'; // Mặc định là 'all'
            
            let currentSuggestion = null;
            let currentType = 'appearance';
            let allDogsData = {}; 
            let isDogListVisible = false; // Flag MỚI để kiểm soát việc render UI

            // --- Helper Functions ---
            
            function showBootstrapAlert(message, type = "success", duration = 3000) {
                  const container = document.getElementById("alert-box-container");
                  const alertBox = document.getElementById("alert-box");
                  alertMessage.textContent = message;

                  const colors = {
                        success: ["#fff8fc", "#f7a3b8", "#a36173"],
                        warning: ["#fef8e7", "#ffc107", "#b66f00"],
                        danger:   ["#ffe0e0", "#ff6b6b", "#c0392b"],
                        info: ["#e3f2fd", "#2196F3", "#1565C0"]
                  };

                  const [bg, border, color] = colors[type] || colors.success;
                  alertBox.style.backgroundColor = bg;
                  alertBox.style.borderColor = border;
                  alertBox.style.color = color;

                  container.classList.add("show");
                  setTimeout(() => container.classList.remove("show"), duration);
            }

            function getSeatFromHash() {
                  const hash = window.location.hash.toLowerCase();
                  const match = hash.match(/^#\/?([lr])(\d)$/);
                  if (match) {
                        const side = match[1] === "r" ? "Bên phải" : "Bên trái";
                        const table = `Bàn ${match[2]}`;
                        return { side, table };
                  }
                  return null;
            }

            function updateSeatDisplay() {
                  const seat = getSeatFromHash();
                  seatInfo.textContent = seat
                        ? `Vị trí của bạn: ${seat.side} - ${seat.table}`
                        : "Vị trí chưa xác định từ đường link!";
            }

            // --- Toggle Logic ---
            function setSelectionMode(mode) {
                  if (mode === 'personality') {
                        suggestionWrapper.classList.add('show-personality');
                        toggleAppearance.classList.remove('active');
                        togglePersonality.classList.add('active');
                  } else {
                        suggestionWrapper.classList.remove('show-personality');
                        toggleAppearance.classList.add('active');
                        togglePersonality.classList.remove('active');
                  }
                  currentType = mode;
            }

            toggleAppearance.addEventListener('click', () => setSelectionMode('appearance'));
            togglePersonality.addEventListener('click', () => setSelectionMode('personality'));

            // --- Event Listeners for Suggestions and Pop-up ---
            document.querySelectorAll('.btn-suggestion').forEach(button => {
                  button.addEventListener('click', () => {
                        currentSuggestion = button.dataset.suggestion;
                        currentType = button.dataset.type;
                        
                        const displaySuggestion = currentSuggestion.replace(/\b\w/g, char => char.toUpperCase()).replace(' ', ', ');

                        popupSuggestionText.textContent = `"${displaySuggestion}"`;
                        suggestionPopup.classList.add('show-popup');
                  });
            });

            confirmSuggestBtn.addEventListener('click', () => {
                  suggestionPopup.classList.remove('show-popup');
                  const suggestion = currentSuggestion;
                  const type = currentType === 'appearance' ? 'Ngoại hình' : 'Tính cách';
                  const seat = getSeatFromHash() || { side: "?", table: "?" };
                  const cooldown = 1800000; // 30 phút = 1800000 ms
                  const now = Date.now();
                  const lastSuggestionTime = localStorage.getItem("lastSuggestionTime");
                  const displaySuggestion = suggestion.replace(/\b\w/g, char => char.toUpperCase()).replace(' ', ', ');


                  if (lastSuggestionTime && (now - parseInt(lastSuggestionTime, 10) < cooldown)) {
                        const wait = (cooldown - (now - lastSuggestionTime)) / 1000;
                        const min = Math.floor(wait / 60);
                        const sec = Math.floor(wait % 60);
                        showBootstrapAlert(`⏳ Vui lòng đợi ${min} phút ${sec} giây trước khi gửi yêu cầu tìm bé khác!`, "warning", 5000);
                        return;
                  }

                  const msg = `vị trí ${seat.side} - ${seat.table} muốn tìm bé cún có đặc điểm (${type}): ${suggestion}.`;
                  const encodedMsg = encodeURIComponent(msg);

                  // Gửi tin nhắn đến Telegram
                  fetch(`https://api.telegram.org/bot7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI/sendMessage?chat_id=-4831972836&text=${encodedMsg}`)
                        .then(response => {
                              if (response.ok) {
                                    localStorage.setItem("lastSuggestionTime", now.toString());
                                    showBootstrapAlert(` Yêu cầu tìm bé (${type}) ${displaySuggestion} của bạn đã được gửi. Nhân viên sẽ hỗ trợ bạn ngay!`, "success", 7000);
                              } else {
                                    showBootstrapAlert("⚠️ Lỗi: Không gửi được yêu cầu, vui lòng thử lại!", "danger");
                              }
                        })
                        .catch(() => {
                              showBootstrapAlert("⚠️ Lỗi kết nối, vui lòng thử lại!", "danger");
                        });
            });

            cancelSuggestBtn.addEventListener('click', () => {
                  suggestionPopup.classList.remove('show-popup');
            });
            
            // --- DOG DETAIL POPUP LOGIC ---
            
            function showDogDetails(dogKey) {
                  const dog = allDogsData[dogKey];

                  if (!dog) {
                        showBootstrapAlert('Không tìm thấy thông tin của bé cún này.', 'danger');
                        return;
                  }
                  
                  const statusText = dog.status ? dog.status.charAt(0).toUpperCase() + dog.status.slice(1) : 'Không rõ';
                  const statusColor = dog.status && dog.status.toLowerCase() === 'rest' ? '#c0392b' : '#27ae60';

                  dogDetailContent.innerHTML = `
                        <img src="${dog.image || 'placeholder.png'}" alt="${dog.name}">
                        <div class="detail-name">${dog.name}</div>
                        <div class="detail-info">
                              <p><strong>Giống:</strong> ${dog.breed || 'Đang cập nhật'}</p>
                              <p><strong>Tính cách:</strong> ${dog.trait || 'Đang cập nhật'}</p>
                              <p><strong>Cảm xúc:</strong> ${dog.emotion || 'Đang cập nhật'}</p>
                              <p><strong>Trạng thái:</strong> <span style="font-weight: bold; color: ${statusColor};">${statusText}</span></p>
                        </div>
                  `;

                  dogDetailPopup.classList.add('show-detail-popup');
            }

            closeDetailPopupBtn.addEventListener('click', () => {
                  dogDetailPopup.classList.remove('show-detail-popup');
            });


            // --- DOG LIST DISPLAY & FILTER LOGIC (Đã tách thành hàm riêng để dễ quản lý) ---
            function renderDogsList(filterBreed = 'all') {
                const dogsData = allDogsData;
                dogListContainerRow.innerHTML = ''; 
                currentFilterBreed = filterBreed;
                
                // Cập nhật trạng thái active của nút filter
                document.querySelectorAll('.btn-filter').forEach(btn => {
                    if (btn.dataset.breedFilter === filterBreed) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });


                if (Object.keys(dogsData).length === 0) {
                    dogListContainerRow.innerHTML = '<p style="margin-top: 15px;">Không tìm thấy dữ liệu cún cưng.</p>';
                    return;
                }

                let dogCount = 0;
                
                for (const key in dogsData) {
                    if (dogsData.hasOwnProperty(key)) {
                          const dog = dogsData[key];

                          // Lọc theo giống (chuyển về chữ thường để so sánh)
                          const dogBreedLower = dog.breed ? dog.breed.toLowerCase() : '';
                          const filterLower = filterBreed.toLowerCase();
                          
                          const matchesFilter = filterLower === 'all' || dogBreedLower.includes(filterLower);


                          if (dog.name && dog.breed && matchesFilter) {
                                const card = document.createElement('div');
                                card.className = 'col';

                                card.innerHTML = `
                                      <div class="dog-card" data-dog-key="${key}">
                                            <img src="${dog.image || 'placeholder.png'}" alt="${dog.name}" class="dog-image">
                                            <div class="dog-name">${dog.name}</div>
                                            <div class="dog-breed">${dog.breed}</div>
                                      </div>
                                `;
                                dogListContainerRow.appendChild(card);
                                dogCount++;
                          }
                    }
                }

                // Cần phải gán lại sự kiện click cho các thẻ mới được tạo
                document.querySelectorAll('.dog-card').forEach(card => {
                      card.addEventListener('click', () => {
                            showDogDetails(card.dataset.dogKey);
                      });
                });


                if (dogCount === 0) {
                      dogListContainerRow.innerHTML = `<p style="margin-top: 15px;">Không tìm thấy bé cún nào thuộc giống <strong>${filterBreed}</strong>.</p>`;
                }
            }


            // --- FETCH DATA LOGIC (Chỉ lắng nghe và lưu trữ dữ liệu) ---
            function fetchDogs() {
                  const dogsRef = db.ref('dogs');
                  dogsRef.on('value', (snapshot) => {
                        allDogsData = {}; // Clear old data
                        
                        // Xử lý dữ liệu và lưu vào biến toàn cục allDogsData
                        if (snapshot.exists()) {
                              const dogsData = snapshot.val();
                              for (const key in dogsData) {
                                    if (dogsData.hasOwnProperty(key)) {
                                          allDogsData[key] = dogsData[key];
                                    }
                              }
                        }
                        
                        // Nếu danh sách đã được hiển thị, cập nhật lại (live update) với bộ lọc hiện tại
                        if (isDogListVisible) {
                            renderDogsList(currentFilterBreed);
                        }

                  }, (error) => {
                        console.error("Lỗi khi đọc dữ liệu Firebase: ", error);
                        // Hiển thị lỗi chỉ khi người dùng đã yêu cầu xem danh sách
                        if (isDogListVisible) {
                            dogListContainerRow.innerHTML = `
                                  <div style="margin-top: 15px; color: red; background: #ffe0e0; border: 1px solid red; padding: 10px; border-radius: 10px;">
                                        <strong>LỖI TẢI DỮ LIỆU FIREBASE:</strong><br>
                                        Mã lỗi: ${error.code}<br>
                                        Chi tiết: ${error.message}
                                  </div>`;
                        }
                  });
            }
            
            // --- BUTTON TẤT CẢ CÚN CƯNG LISTENER ---
            showDogsBtn.addEventListener('click', () => {
                  isDogListVisible = true;
                  showDogsBtn.style.display = 'none'; // Ẩn nút sau khi click
                  dogListTitle.style.display = 'block'; // Hiển thị tiêu đề
                  dogFilterContainer.style.display = 'flex'; // HIỂN THỊ CÁC NÚT LỌC MỚI
                  dogListContainerDiv.style.display = 'block'; // Hiển thị container
                  
                  // Gọi hàm render để hiển thị dữ liệu đã được lắng nghe (mặc định 'all')
                  renderDogsList('all'); 
            });
            
            // --- LISTENER CHO CÁC NÚT LỌC ---
            dogFilterContainer.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('btn-filter')) {
                    const breed = target.dataset.breedFilter;
                    // Lọc lại danh sách
                    renderDogsList(breed); 
                }
            });


            window.addEventListener("hashchange", updateSeatDisplay);
            window.addEventListener("DOMContentLoaded", () => {
                  updateSeatDisplay();
                  fetchDogs(); // Chỉ bắt đầu lắng nghe dữ liệu, KHÔNG hiển thị ra màn hình.
            });
      </script>
</body>
</html>