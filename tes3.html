<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống phân công nhân sự - Live Preview</title>
    <style>
        /* ========================================= */
        /* CSS CHO FORM VÀ NÚT UNDO CỐ ĐỊNH */
        /* ========================================= */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }

        #assignment-form-container {
            max-width: 1200px;
            margin: auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 60px; /* Thêm khoảng cách để nút cố định không che mất tiêu đề */
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .day-container {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #fafafa;
        }

        .day-container h2 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .shift-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .shift-section {
            flex: 1 1 45%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
        }

        .shift-section h3 {
            margin-top: 0;
            color: #777;
        }

        .job-position {
            margin-bottom: 10px;
        }

        .job-position label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444;
        }

        .job-position input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .job-position input:focus {
            border-color: #007bff;
        }

        /* Nút UNDO cố định */
        #undo-button-fixed {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 1000;
            padding: 10px 15px;
            background-color: #ffc107;
            color: #333;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, opacity 0.3s;
        }

        #undo-button-fixed:hover:not(:disabled) {
            background-color: #e0a800;
        }

        #undo-button-fixed:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-group button {
            padding: 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .button-group button:hover {
            background-color: #0056b3;
        }

        /* ========================================= */
        /* CSS CHO BẢNG LIVE PREVIEW VÀ ANIMATION */
        /* ========================================= */

        #schedule-table-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .schedule-table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
            margin-bottom: 30px;
        }
        
        .schedule-table th, .schedule-table td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
            vertical-align: top;
            font-size: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .schedule-table th {
            background-color: #007bff;
            color: #fff;
            font-weight: bold;
            text-align: center;
        }

        /* Animation cho cell */
        .schedule-table td.updated-cell {
            background-color: #d4edda; /* Màu nền nhẹ khi update */
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0.5;
                background-color: #fff3cd; /* Flash màu vàng nhẹ */
            }
            to {
                opacity: 1;
                background-color: transparent;
            }
        }

        .schedule-table td {
            transition: background-color 0.5s; /* Đảm bảo màu nền trở về bình thường */
        }

        .note-row td {
            font-style: italic;
            font-weight: bold;
            padding: 8px 5px;
            text-align: left;
            background-color: #eaf6ff;
        }

        .save-button-container {
            text-align: center;
            margin-top: 20px;
        }

        .save-button-container button {
            width: auto;
            padding: 10px 20px;
            background-color: #28a745;
        }

        .save-button-container button:hover {
            background-color: #1e7e34;
        }

    </style>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<button type="button" id="undo-button-fixed" onclick="undoLastAction()" disabled title="Quay lại thao tác nhập liệu trước đó.">
    ↩️ Quay lại thao tác trước
</button>

<div id="assignment-form-container">
    <h1>NHẬP LIỆU PHÂN CÔNG TUẦN</h1>
    <form id="assignmentForm">
        <div class="day-container" id="day-2">
            <h2>Thứ 2</h2>
            <div class="shift-group">
                <div class="shift-section">
                    <h3>SÁNG</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t2-sang-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t2-sang-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t2-sang-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t2-sang-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t2-sang-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t2-sang-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t2-sang-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t2-sang-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
                <div class="shift-section">
                    <h3>CHIỀU</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t2-chieu-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t2-chieu-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t2-chieu-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t2-chieu-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t2-chieu-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t2-chieu-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t2-chieu-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t2-chieu-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
            </div>
            <div class="job-position"><label>Lịch off:</label><input type="text" name="t2-note" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
        </div>

        <div class="day-container" id="day-3">
            <h2>Thứ 3</h2>
            <div class="shift-group">
                <div class="shift-section">
                    <h3>SÁNG</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t3-sang-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t3-sang-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t3-sang-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t3-sang-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t3-sang-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t3-sang-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t3-sang-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t3-sang-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
                <div class="shift-section">
                    <h3>CHIỀU</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t3-chieu-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t3-chieu-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t3-chieu-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t3-chieu-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t3-chieu-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t3-chieu-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t3-chieu-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t3-chieu-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
            </div>
            <div class="job-position"><label>Lịch off:</label><input type="text" name="t3-note" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
        </div>

        <div class="day-container" id="day-4">
            <h2>Thứ 4</h2>
            <div class="shift-group">
                <div class="shift-section">
                    <h3>SÁNG</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t4-sang-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t4-sang-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t4-sang-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t4-sang-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t4-sang-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t4-sang-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t4-sang-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t4-sang-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
                <div class="shift-section">
                    <h3>CHIỀU</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t4-chieu-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t4-chieu-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t4-chieu-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t4-chieu-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t4-chieu-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t4-chieu-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t4-chieu-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t4-chieu-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
            </div>
            <div class="job-position"><label>Lịch off:</label><input type="text" name="t4-note" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
        </div>

        <div class="day-container" id="day-5">
            <h2>Thứ 5</h2>
            <div class="shift-group">
                <div class="shift-section">
                    <h3>SÁNG</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t5-sang-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t5-sang-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t5-sang-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t5-sang-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t5-sang-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t5-sang-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t5-sang-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t5-sang-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
                <div class="shift-section">
                    <h3>CHIỀU</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t5-chieu-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t5-chieu-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t5-chieu-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t5-chieu-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t5-chieu-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t5-chieu-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t5-chieu-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t5-chieu-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
            </div>
            <div class="job-position"><label>Lịch off:</label><input type="text" name="t5-note" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
        </div>

        <div class="day-container" id="day-6">
            <h2>Thứ 6</h2>
            <div class="shift-group">
                <div class="shift-section">
                    <h3>SÁNG</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t6-sang-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t6-sang-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t6-sang-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t6-sang-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t6-sang-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t6-sang-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t6-sang-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t6-sang-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
                <div class="shift-section">
                    <h3>CHIỀU</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t6-chieu-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t6-chieu-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t6-chieu-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t6-chieu-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t6-chieu-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t6-chieu-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t6-chieu-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t6-chieu-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
            </div>
            <div class="job-position"><label>Lịch off:</label><input type="text" name="t6-note" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
        </div>

        <div class="day-container" id="day-7">
            <h2>Thứ 7</h2>
            <div class="shift-group">
                <div class="shift-section">
                    <h3>SÁNG</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t7-sang-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t7-sang-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t7-sang-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t7-sang-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t7-sang-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t7-sang-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t7-sang-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t7-sang-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
                <div class="shift-section">
                    <h3>CHIỀU</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="t7-chieu-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="t7-chieu-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="t7-chieu-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="t7-chieu-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="t7-chieu-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="t7-chieu-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="t7-chieu-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="t7-chieu-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
            </div>
            <div class="job-position"><label>Lịch off:</label><input type="text" name="t7-note" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
        </div>

        <div class="day-container" id="day-cn">
            <h2>Chủ Nhật</h2>
            <div class="shift-group">
                <div class="shift-section">
                    <h3>SÁNG</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="cn-sang-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="cn-sang-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="cn-sang-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="cn-sang-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="cn-sang-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="cn-sang-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="cn-sang-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="cn-sang-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
                <div class="shift-section">
                    <h3>CHIỀU</h3>
                    <div class="job-position"><label>Oder:</label><input type="text" name="cn-chieu-oder" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Trệt:</label><input type="text" name="cn-chieu-tret" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Gấu mèo:</label><input type="text" name="cn-chieu-gaumeo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Mèo:</label><input type="text" name="cn-chieu-meo" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog1:</label><input type="text" name="cn-chieu-petdog1" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Pet dog2:</label><input type="text" name="cn-chieu-petdog2" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Spa:</label><input type="text" name="cn-chieu-spa" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                    <div class="job-position"><label>Capybara:</label><input type="text" name="cn-chieu-capybara" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
                </div>
            </div>
            <div class="job-position"><label>Lịch off:</label><input type="text" name="cn-note" oninput="liveUpdate(this)" onblur="saveStateAndLocalStorage()"></div>
        </div>

        <div class="button-group">
            <button type="button" onclick="scrollToTables()">Xem bảng phân công chi tiết</button>
        </div>
    </form>
</div>

<div id="schedule-table-container">
    <h2>Bảng phân công ca SÁNG</h2>
    <table id="schedule-table-sang" class="schedule-table">
        <thead>
            <tr>
                <th>Vị trí</th>
                <th>Thứ 2</th>
                <th>Thứ 3</th>
                <th>Thứ 4</th>
                <th>Thứ 5</th>
                <th>Thứ 6</th>
                <th>Thứ 7</th>
                <th>Chủ Nhật</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Bảng phân công ca CHIỀU</h2>
    <table id="schedule-table-chieu" class="schedule-table">
        <thead>
            <tr>
                <th>Vị trí</th>
                <th>Thứ 2</th>
                <th>Thứ 3</th>
                <th>Thứ 4</th>
                <th>Thứ 5</th>
                <th>Thứ 6</th>
                <th>Thứ 7</th>
                <th>Chủ Nhật</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Lịch off</h2>
    <table id="schedule-table-notes" class="schedule-table">
        <tbody>
        </tbody>
    </table>
    
    <div class="save-button-container">
        <button type="button" onclick="saveAsImage()">Lưu bảng phân công thành ảnh</button>
    </div>
</div>

<script>
    const STORAGE_KEY = 'assignmentFormDataLive';
    const UNDO_STACK = [];
    const MAX_UNDO_STATES = 10;
    const form = document.getElementById('assignmentForm');
    const undoButton = document.getElementById('undo-button-fixed');
    
    const POSITIONS = [
        { label: 'Oder', key: 'oder' },
        { label: 'Trệt', key: 'tret' },
        { label: 'Gấu mèo', key: 'gaumeo' },
        { label: 'Mèo', key: 'meo' },
        { label: 'Pet dog1', key: 'petdog1' },
        { label: 'Pet dog2', key: 'petdog2' },
        { label: 'Spa', key: 'spa' },
        { label: 'Capybara', key: 'capybara' }
    ];
    const DAYS = ['t2', 't3', 't4', 't5', 't6', 't7', 'cn'];
    const DAY_MAP = { 't2': 1, 't3': 2, 't4': 3, 't5': 4, 't6': 5, 't7': 6, 'cn': 7 }; // Map ngày sang chỉ số cột trong bảng

    // Khởi tạo trạng thái và tải dữ liệu khi trang tải
    document.addEventListener('DOMContentLoaded', () => {
        setupTables();
        loadData();
        // Lấy trạng thái form ban đầu để làm trạng thái undo đầu tiên
        UNDO_STACK.push(getFormData());
        updateUndoButtonState();
        liveUpdateAll(); // Cập nhật toàn bộ bảng sau khi load data
    });

    /**
     * Khởi tạo cấu trúc các bảng (chỉ tạo các hàng tĩnh)
     */
    function setupTables() {
        const tableBodySang = document.querySelector('#schedule-table-sang tbody');
        const tableBodyChieu = document.querySelector('#schedule-table-chieu tbody');
        const tableBodyNotes = document.querySelector('#schedule-table-notes tbody');

        // Tạo bảng ca SÁNG và ca CHIỀU
        POSITIONS.forEach(pos => {
            // Sáng
            let rowSang = document.createElement('tr');
            rowSang.setAttribute('data-position', pos.key);
            rowSang.innerHTML = `<td><b>${pos.label}</b></td>` + DAYS.map(day => 
                `<td id="cell-${day}-sang-${pos.key}" data-day="${day}" data-shift="sang" data-pos="${pos.key}"></td>`
            ).join('');
            tableBodySang.appendChild(rowSang);

            // Chiều
            let rowChieu = document.createElement('tr');
            rowChieu.setAttribute('data-position', pos.key);
            rowChieu.innerHTML = `<td><b>${pos.label}</b></td>` + DAYS.map(day => 
                `<td id="cell-${day}-chieu-${pos.key}" data-day="${day}" data-shift="chieu" data-pos="${pos.key}"></td>`
            ).join('');
            tableBodyChieu.appendChild(rowChieu);
        });

        // Tạo bảng Ghi chú
        const noteRow = document.createElement('tr');
        noteRow.className = 'note-row';
        noteRow.innerHTML = `<td style="font-weight: bold; text-align: center;">Lịch off</td>` + DAYS.map(day => 
            `<td id="cell-${day}-note" data-day="${day}" data-shift="note" data-pos="note"></td>`
        ).join('');
        tableBodyNotes.appendChild(noteRow);
    }

    /**
     * Cập nhật một ô trong bảng Live Preview
     * @param {HTMLInputElement} input - Element input vừa thay đổi
     */
    function liveUpdate(input) {
        // Tên input: t2-sang-oder (day-shift-position)
        const [day, shift, pos] = input.name.split('-');
        const cellId = `cell-${day}-${shift}-${pos}`;
        const cell = document.getElementById(cellId);
        
        if (cell) {
            // Loại bỏ class animation cũ
            cell.classList.remove('updated-cell');
            
            // Cập nhật nội dung
            cell.textContent = input.value;
            
            // Thêm class animation mới
            // Sử dụng setTimeout 0ms để đảm bảo trình duyệt đã loại bỏ class cũ trước khi thêm lại
            setTimeout(() => {
                cell.classList.add('updated-cell');
            }, 50);

            // Sau khi animation chạy xong, loại bỏ class để chuẩn bị cho lần cập nhật tiếp theo
            setTimeout(() => {
                cell.classList.remove('updated-cell');
            }, 550); // 500ms là thời gian animation
        }
    }

    /**
     * Cập nhật toàn bộ bảng (thường dùng khi tải trang hoặc undo)
     */
    function liveUpdateAll() {
        const formData = getFormData();
        for (const name in formData) {
            const value = formData[name];
            const [day, shift, pos] = name.split('-');
            if (day && shift && pos) {
                const cellId = `cell-${day}-${shift}-${pos}`;
                const cell = document.getElementById(cellId);
                if (cell) {
                    cell.textContent = value;
                }
            } else if (day && shift === 'note') {
                const cellId = `cell-${day}-note`;
                const cell = document.getElementById(cellId);
                 if (cell) {
                    cell.textContent = value;
                }
            }
        }
    }


    /* ========================================= */
    /* LOGIC LƯU TRỮ VÀ UNDO */
    /* ========================================= */

    function getFormData() {
        const formData = {};
        const inputs = form.querySelectorAll('input[type="text"]');
        inputs.forEach(input => {
            formData[input.name] = input.value;
        });
        return formData;
    }

    function setFormData(data) {
        for (const name in data) {
            const input = form.querySelector(`[name="${name}"]`);
            if (input) {
                input.value = data[name];
            }
        }
    }

    function updateUndoButtonState() {
        // Nút disable nếu chỉ còn trạng thái ban đầu (size=1)
        undoButton.disabled = UNDO_STACK.length <= 1;
        undoButton.title = UNDO_STACK.length > 1 ? "Quay lại thao tác nhập liệu trước đó." : "Không có thao tác nào để quay lại.";
    }

    /**
     * Lưu trạng thái hiện tại của form vào stack và Local Storage.
     * Được gọi khi input bị blur (mất focus).
     */
    function saveStateAndLocalStorage() {
        const currentData = getFormData();
        
        // 1. Lưu vào Local Storage để tránh mất dữ liệu khi refresh
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));

        // 2. Lưu vào Undo Stack
        const lastState = UNDO_STACK[UNDO_STACK.length - 1];
        if (JSON.stringify(lastState) !== JSON.stringify(currentData)) {
            // Chỉ thêm vào stack nếu có sự thay đổi
            UNDO_STACK.push(currentData);
            
            // Giữ stack không quá lớn
            if (UNDO_STACK.length > MAX_UNDO_STATES) {
                UNDO_STACK.shift(); // Xóa phần tử đầu tiên (trạng thái cũ nhất)
            }
            updateUndoButtonState();
        }
    }

    /**
     * Thực hiện thao tác Quay lại (Undo)
     */
    function undoLastAction() {
        if (UNDO_STACK.length > 1) {
            // Bỏ trạng thái hiện tại
            UNDO_STACK.pop(); 
            // Lấy trạng thái trước đó
            const previousState = UNDO_STACK[UNDO_STACK.length - 1];
            
            setFormData(previousState);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(previousState));
            liveUpdateAll(); // Cập nhật lại giao diện sau khi undo
            updateUndoButtonState();

            // Hiệu ứng nhẹ cho biết undo thành công
            undoButton.style.backgroundColor = '#d4edda';
            undoButton.style.color = '#155724';
            setTimeout(() => {
                undoButton.style.backgroundColor = '#ffc107';
                undoButton.style.color = '#333';
            }, 300);
        }
    }

    function loadData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            const data = JSON.parse(savedData);
            setFormData(data);
        }
    }
    
    /* ========================================= */
    /* CÁC HÀM KHÁC */
    /* ========================================= */

    function scrollToTables() {
        document.getElementById('schedule-table-container').scrollIntoView({ behavior: 'smooth' });
    }

    /**
     * Lưu bảng phân công thành ảnh.
     */
    function saveAsImage() {
        const scheduleContainer = document.getElementById('schedule-table-container');
        const saveButtonContainer = scheduleContainer.querySelector('.save-button-container');

        // Ẩn nút "Lưu ảnh" trước khi chụp
        if (saveButtonContainer) {
            saveButtonContainer.style.display = 'none';
        }

        // Dùng html2canvas để chụp ảnh nội dung
        html2canvas(scheduleContainer, {
            scale: 2, // Tăng độ phân giải để ảnh sắc nét hơn
            useCORS: true 
        }).then(function(canvas) {
            // Hiện lại nút sau khi chụp
            if (saveButtonContainer) {
                saveButtonContainer.style.display = 'block';
            }

            // Tự động tải về
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'bang_phan_cong_nhan_su_live.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Đã lưu bảng phân công thành ảnh!');
        }).catch(function(error) {
            console.error('Lỗi khi lưu ảnh:', error);
            alert('Đã xảy ra lỗi khi lưu ảnh. Vui lòng thử lại.');
            // Đảm bảo hiện lại nút ngay cả khi có lỗi
            if (saveButtonContainer) {
                saveButtonContainer.style.display = 'block';
            }
        });
    }
</script>

</body>
</html>
