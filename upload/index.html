<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üì§ Upload ·∫¢nh Kh√°ch - Cherry Pet Coffee</title>
  
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fcefee, #ffe6f0);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-x: hidden;
      color: #4a3c57;
    }
    .upload-container {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(255, 102, 180, 0.25);
      padding: 40px 50px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      position: relative;
      animation: slideInUp 0.8s ease forwards;
    }
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      font-weight: 600;
      font-size: 1.9rem;
      color: #d6336c;
      margin-bottom: 24px;
    }
    label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #c72c66;
      display: block;
      margin-bottom: 6px;
      text-align: left;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 14px 16px;
      border: 2.5px solid #f9a7ca;
      border-radius: 12px;
      font-size: 1rem;
      background-color: #fff0f5;
      margin-bottom: 20px;
      font-weight: 500;
      cursor: pointer;
    }
    button {
      background: linear-gradient(135deg, #e92a74, #ff5599);
      border: none;
      color: white;
      font-weight: 600;
      font-size: 1.15rem;
      padding: 14px 0;
      width: 100%;
      border-radius: 18px;
      box-shadow: 0 8px 18px rgba(255, 85, 153, 0.4);
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: linear-gradient(135deg, #ff3a8a, #ff7ab2);
      transform: translateY(-2px);
    }
    #result {
      margin-top: 28px;
      font-size: 1rem;
      font-weight: 600;
      color: #ad1457;
      min-height: 38px;
    }
    #result a {
      color: #e91e63;
      text-decoration: none;
      font-weight: 700;
    }
    ul {
      list-style: none;
      padding: 0;
      text-align: left;
      margin-top: 10px;
    }
    li {
      margin-bottom: 8px;
    }
    input[type="checkbox"] {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="upload-container">
    <h2>üì§ Upload ·∫£nh kh√°ch</h2>
    <input type="hidden" id="token" />

    <label for="tenKhach">üßë Nh·∫≠p t√™n kh√°ch</label>
    <input type="text" id="tenKhach" placeholder="v√≠ d·ª•: nguyen-thi-a" autocomplete="off" />

    <label for="fileInput">üìÇ Ch·ªçn ·∫£nh (nhi·ªÅu ·∫£nh)</label>
    <input type="file" id="fileInput" accept="image/*" multiple />

    <button onclick="uploadImages()">üì§ T·∫£i ·∫£nh l√™n</button>

    <div id="result"></div>
    <div id="imageListContainer"></div>
    <button id="deleteButton" onclick="deleteSelectedImages()" style="display: none;">üóëÔ∏è X√≥a ·∫£nh ƒë√£ ch·ªçn</button>
  </div>

  <!-- JS Firebase + SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const REPO_OWNER = 'thanhchan791791';
    const REPO_NAME = 'hihihi';
    const BRANCH = 'main';
    const IMAGE_FOLDER = 'ImagesKhach';

    const firebaseConfig = {
      apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
      authDomain: "dogs-be72b.firebaseapp.com",
      databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
      projectId: "dogs-be72b",
      storageBucket: "dogs-be72b.appspot.com",
      messagingSenderId: "1003873040746",
      appId: "1:1003873040746:web:607f4ff587afc430d3cd13"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64Data = reader.result.split(',')[1];
          resolve(base64Data);
        };
        reader.onerror = () => reject("L·ªói ƒë·ªçc ·∫£nh");
        reader.readAsDataURL(file);
      });
    }

    async function uploadImages() {
      const files = document.getElementById("fileInput").files;
      const tenKhachRaw = document.getElementById("tenKhach").value.trim();
      const resultDiv = document.getElementById("result");
      const imageListContainer = document.getElementById("imageListContainer");
      const deleteButton = document.getElementById("deleteButton");

      if (files.length === 0 || !tenKhachRaw) {
        alert("‚ùó Vui l√≤ng ch·ªçn ·∫£nh v√† nh·∫≠p t√™n kh√°ch.");
        return;
      }

      const tenKhach = tenKhachRaw.toLowerCase().replace(/\s+/g, '-');
      resultDiv.innerHTML = `‚è≥ ƒêang t·∫£i ·∫£nh l√™n...`;

      let tokenSnapshot;
      try {
        tokenSnapshot = await firebase.database().ref("config/githubToken").once("value");
      } catch (err) {
        Swal.fire("‚ùå L·ªói k·∫øt n·ªëi Firebase", err.message, "error");
        return;
      }

      const token = tokenSnapshot.val();
      if (!token) {
        Swal.fire("‚ùå Kh√¥ng t√¨m th·∫•y token!", "Ki·ªÉm tra m·ª•c config/githubToken tr√™n Firebase", "error");
        return;
      }

      const uploadedLinks = [];
      for (let file of files) {
        const fileName = file.name;
        const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${IMAGE_FOLDER}/${fileName}`;
        try {
          const base64 = await readFileAsBase64(file);
          const response = await fetch(apiUrl, {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: `Upload ${fileName}`,
              content: base64,
              branch: BRANCH,
            }),
          });

          if (response.ok) {
            uploadedLinks.push(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${IMAGE_FOLDER}/${fileName}`);
          }
        } catch (err) {
          console.warn(`‚ùå L·ªói khi upload ${fileName}:`, err);
        }
      }

      if (uploadedLinks.length > 0) {
        await db.ref("anhKhach/" + tenKhach).set(uploadedLinks);

        resultDiv.innerHTML = `‚úÖ ƒê√£ upload ${uploadedLinks.length} ·∫£nh cho <strong>${tenKhach}</strong>`;
        imageListContainer.innerHTML = `
          <p>üì∏ Danh s√°ch ·∫£nh:</p>
          <ul>
            ${uploadedLinks.map(url => {
              const name = url.split('/').pop();
              return `<li><label><input type="checkbox" value="${name}" /> <a href="${url}" target="_blank">${name}</a></label></li>`;
            }).join('')}
          </ul>
        `;
        deleteButton.style.display = "block";
      } else {
        resultDiv.innerHTML = "‚ùå Kh√¥ng c√≥ ·∫£nh n√†o ƒë∆∞·ª£c upload.";
      }
    }

    async function deleteSelectedImages() {
      const checkboxes = document.querySelectorAll('#imageListContainer input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        Swal.fire("‚ö†Ô∏è Ch∆∞a ch·ªçn ·∫£nh ƒë·ªÉ x√≥a.");
        return;
      }

      const confirm = await Swal.fire({
        title: "B·∫°n ch·∫Øc ch·∫Øn?",
        text: `B·∫°n mu·ªën x√≥a ${checkboxes.length} ·∫£nh?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "X√≥a",
        cancelButtonText: "H·ªßy"
      });
      if (!confirm.isConfirmed) return;

      const tenKhach = document.getElementById("tenKhach").value.trim().toLowerCase().replace(/\s+/g, '-');
      const tokenSnapshot = await firebase.database().ref("config/githubToken").once("value");
      const token = tokenSnapshot.val();

      let deleted = 0;
      for (let checkbox of checkboxes) {
        const fileName = checkbox.value;
        const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${IMAGE_FOLDER}/${fileName}`;

        const shaRes = await fetch(apiUrl, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const shaData = await shaRes.json();
        const sha = shaData.sha;
        if (!sha) continue;

        const deleteRes = await fetch(apiUrl, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: `Delete ${fileName}`,
            sha: sha,
            branch: BRANCH,
          }),
        });

        if (deleteRes.ok) deleted++;
      }

      Swal.fire("üóëÔ∏è ƒê√£ x√≥a", `${deleted} ·∫£nh ƒë√£ ƒë∆∞·ª£c x√≥a.`, "success");
      document.getElementById("imageListContainer").innerHTML = "";
      document.getElementById("deleteButton").style.display = "none";
      document.getElementById("result").innerHTML += `<br>üîÅ Vui l√≤ng upload l·∫°i n·∫øu mu·ªën xem danh s√°ch m·ªõi.`;
    }
  </script>
</body>
</html>
