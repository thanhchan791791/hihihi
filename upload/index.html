<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Upload áº£nh khÃ¡ch nhiá»u áº£nh</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ğŸ“¤ Upload nhiá»u áº£nh khÃ¡ch lÃªn GitHub + lÆ°u theo tÃªn khÃ¡ch</h2>

  <label>ğŸ”‘ GitHub Token:</label><br>
  <input type="password" id="token" placeholder="github_pat_..." style="width:300px;"><br><br>

  <label>ğŸ§‘ Nháº­p tÃªn khÃ¡ch:</label><br>
  <input type="text" id="tenKhach" placeholder="vÃ­ dá»¥: nguyen-thi-a"><br><br>

  <input type="file" id="fileInput" accept="image/*" multiple><br><br>
  <button onclick="uploadImages()">ğŸ“¤ Táº£i áº£nh lÃªn</button>

  <div id="result" style="margin-top:20px;"></div>

  <script>
    // GitHub config
    const REPO_OWNER = 'thanhchan791791';
    const REPO_NAME = 'hihihi';
    const BRANCH = 'main';
    const IMAGE_FOLDER = 'ImagesKhach';

  const firebaseConfig = {
  apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
  authDomain: "dogs-be72b.firebaseapp.com",
  databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
  projectId: "dogs-be72b",
  storageBucket: "dogs-be72b.appspot.com",
  messagingSenderId: "1003873040746",
  appId: "1:1003873040746:web:607f4ff587afc430d3cd13"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

  async function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64Data = reader.result.split(',')[1];
      resolve(base64Data);
    };
    reader.onerror = () => reject("Lá»—i Ä‘á»c áº£nh");
    reader.readAsDataURL(file);
  });
}

async function uploadSingleImage(file, token, tenKhach, index) {
  const ext = file.name.split('.').pop();
  const timestamp = Date.now();
  const fileName = `${tenKhach}-${timestamp}-${index + 1}.${ext}`;
  const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${IMAGE_FOLDER}/${fileName}`;

  try {
    const base64Content = await readFileAsBase64(file);
    const response = await fetch(apiUrl, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        message: `Upload ${fileName}`,
        content: base64Content,
        branch: BRANCH,
      }),
    });

    const data = await response.json();

    if (response.ok) {
      const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${IMAGE_FOLDER}/${fileName}`;
      return { success: true, url };
    } else {
      console.warn(`âŒ Upload áº£nh ${index + 1} tháº¥t báº¡i:`, data.message);
      return { success: false, error: data.message };
    }
  } catch (err) {
    console.error(`âŒ Lá»—i upload áº£nh ${index + 1}:`, err);
    return { success: false, error: err };
  }
}

async function uploadImages() {
  const files = document.getElementById("fileInput").files;
  const token = document.getElementById("token").value.trim();
  const tenKhachRaw = document.getElementById("tenKhach").value.trim();

  if (files.length === 0 || !tenKhachRaw || !token) {
    alert("â— Vui lÃ²ng chá»n áº£nh, nháº­p tÃªn khÃ¡ch vÃ  token.");
    return;
  }

  const tenKhach = tenKhachRaw.toLowerCase().replace(/\s+/g, '-');

  document.getElementById("result").innerHTML = "â³ Äang táº£i lÃªn...";

  // Upload áº£nh song song (cÃ³ thá»ƒ Ä‘á»•i thÃ nh tuáº§n tá»± náº¿u cáº§n)
  const uploadPromises = [];
  for (let i = 0; i < files.length; i++) {
    uploadPromises.push(uploadSingleImage(files[i], token, tenKhach, i));
  }

  const results = await Promise.all(uploadPromises);

  const uploadedLinks = results
    .filter(r => r.success)
    .map(r => r.url);

  const failedCount = results.length - uploadedLinks.length;

  if (uploadedLinks.length > 0) {
    await db.ref("anhKhach/" + tenKhach).set(uploadedLinks);

    document.getElementById("result").innerHTML = `
      âœ… Upload thÃ nh cÃ´ng ${uploadedLinks.length} áº£nh cho <strong>${tenKhach}</strong>.<br>
      ${failedCount > 0 ? `âš ï¸ CÃ³ ${failedCount} áº£nh upload tháº¥t báº¡i.<br>` : ""}
      <a href="https://github.com/${REPO_OWNER}/${REPO_NAME}/tree/${BRANCH}/${IMAGE_FOLDER}" target="_blank">ğŸ“ Xem áº£nh trÃªn GitHub</a>
    `;

    Swal.fire(
      "âœ… Upload hoÃ n táº¥t!",
      `ÄÃ£ lÆ°u ${uploadedLinks.length} áº£nh cho ${tenKhach}` + (failedCount > 0 ? `\nCÃ³ ${failedCount} áº£nh tháº¥t báº¡i` : ""),
      "success"
    );
  } else {
    document.getElementById("result").innerHTML = "âŒ KhÃ´ng upload Ä‘Æ°á»£c áº£nh nÃ o!";
    Swal.fire("âŒ Upload tháº¥t báº¡i", "KhÃ´ng cÃ³ áº£nh nÃ o Ä‘Æ°á»£c táº£i lÃªn thÃ nh cÃ´ng.", "error");
  }
}

  </script>
</body>
</html>
