<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üê∂ Qu·∫£n l√Ω tr·∫°ng th√°i ch√≥</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-soft@5/soft.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(to bottom, #fffafc, #ffeef5);
      padding: 16px;
      margin: auto;
      max-width: 100%;
    }
    #statusDisplay {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(255, 245, 250, 0.95);
      backdrop-filter: blur(3px);
    }

    h1 {
      font-size: 1.8rem;
      color: #ff4d79;
      text-shadow: 1px 1px 1px #ffd6e8;
    }

    .status-box {
      background: linear-gradient(to right, #ffb3c6, #ffd6e8);
      border: 2px dashed #ff69b4;
      padding: 12px 20px;
      font-size: 1.2rem;
      color: #6b0033;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(255, 105, 180, 0.2);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.5); }
      70% { box-shadow: 0 0 0 10px rgba(255, 105, 180, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0); }
    }

    .table {
      border: 2px solid #ffc2d1;
      border-radius: 12px;
      background-color: #fff0f5;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
    }

    .table thead {
      background-color: #ffb3c6;
      color: #fff;
      font-weight: 600;
    }

    .table tbody tr {
      background-color: #fff5f7;
      transition: background 0.3s;
    }

    .table tbody tr:hover {
      background-color: #ffe0ea;
    }

    .table td, .table th {
      vertical-align: middle;
      border: 1px solid #ffc2d1;
    }

    table img {
      width: 80px;
      height: 64px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #ffc2d1;
    }

    .btn {
      border-radius: 20px;
      font-size: 0.9rem;
      padding: 6px 12px;
    }

    .modal-content {
      background-color: #fff0f5;
      border: 2px solid #ffd6e8;
      border-radius: 16px;
    }

    .form-control {
      border-radius: 12px;
      border: 1px solid #ffccd5;
    }

    .alert-info {
      background-color: #ffeef5;
      border: 1px solid #ffc2d1;
      color: #d63384;
      font-weight: 600;
    }

    .input-group-text.bg-pink {
      background-color: #ffc2d1;
      color: #fff;
      border: 1px solid #ffc2d1;
    }

    .input-group .form-control::placeholder {
      color: #d63384;
      font-style: italic;
    }

    .input-group .form-control {
      font-size: 1.1rem;
      font-weight: 500;
      background-color: #fff5f8;
    }

    @media (max-width: 768px) {
      .table thead {
        display: none;
      }

      .table tbody tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #ffc2d1;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: #fff;
        padding: 10px;
      }

      .table td {
        display: flex;
        justify-content: space-between;
        padding: 8px 10px;
        border: none;
        border-bottom: 1px solid #ffc2d1;
      }

      .table td:last-child {
        border-bottom: none;
      }

      .table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #d63384;
      }

      table img {
        width: 64px;
        height: 50px;
      }
    }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">üê∂ C·∫≠p nh·∫≠t tr·∫°ng th√°i ch√≥ üê∂</h1>

  <div class="alert alert-info" id="notification">üîî ƒêang t·∫£i th√¥ng b√°o...</div>

  <div class="status-box text-center fw-semibold mb-3" id="statusDisplay">
    üêæ ƒêang t·∫£i tr·∫°ng th√°i...
  </div>

  <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
    <button class="btn btn-danger" onclick="clearNotifications()">üóëÔ∏è X√≥a t·∫•t c·∫£ th√¥ng b√°o</button>
    <button class="btn btn-success" onclick="openForm()">‚ûï Th√™m ch√≥ m·ªõi</button>
    <button class="btn btn-warning" onclick="setAllToRest()">üåô Cho t·∫•t c·∫£ ngh·ªâ</button>
  </div>

  <div class="input-group mb-4 shadow-lg" style="max-width: 500px; margin: auto; font-size: 1.2rem;">
    <span class="input-group-text bg-pink">
      <i class="fas fa-dog"></i>
    </span>
    <input type="text" id="searchInput" class="form-control py-2" placeholder="T√¨m theo t√™n b√© c√∫n..." oninput="renderFilteredDogs()">
  </div>

  <table class="table table-bordered table-hover text-center">
    <thead>
      <tr>
        <th>·∫¢nh</th>
        <th>T√™n</th>
        <th>Gi·ªëng</th>
        <th>T√≠nh c√°ch</th>
        <th>Tr·∫°ng th√°i</th>
        <th>L∆∞·ª£t ch·ªçn</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="dog-table-body"></tbody>
  </table>

  <!-- Modal -->
  <div class="modal fade" id="dogModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="form-title">Th√™m ch√≥</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="dog-id">
          <input type="text" id="dog-name" class="form-control mb-2" placeholder="T√™n">
          <input type="text" id="dog-breed" class="form-control mb-2" placeholder="Gi·ªëng">
          <input type="text" id="dog-trait" class="form-control mb-2" placeholder="T√≠nh c√°ch">
          <input type="text" id="dog-image" class="form-control mb-2" placeholder="Link ·∫£nh">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
          <button type="button" class="btn btn-primary" onclick="submitDog()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Bootstrap -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
    authDomain: "dogs-be72b.firebaseapp.com",
    databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
    projectId: "dogs-be72b",
    storageBucket: "dogs-be72b.appspot.com",
    messagingSenderId: "1003873040746",
    appId: "1:1003873040746:web:607f4ff587afc430d3cd13"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const tableBody = document.getElementById("dog-table-body");
  const searchInput = document.getElementById("searchInput");
  const notificationBox = document.getElementById("notification");
  const statusDisplay = document.getElementById("statusDisplay");
  const dogModal = new bootstrap.Modal(document.getElementById('dogModal'));
  let allDogs = {}, dogCounts = {};

  function loadDogs() {
    db.ref("dogs").on("value", snapshot => {
      allDogs = snapshot.val() || {};
      renderFilteredDogs();
    });
  }

  function loadCounts() {
    db.ref("photoRequests").on("value", snapshot => {
      dogCounts = {};
      const data = snapshot.val();
      if (!data) return;
      Object.values(data).forEach(item => {
        const selected = Array.isArray(item.selectedDogs) ? item.selectedDogs : item.dog ? [item.dog] : [];
        selected.forEach(name => {
          if (!name) return;
          dogCounts[name] = (dogCounts[name] || 0) + 1;
        });
      });
      renderFilteredDogs();
    });
  }

  function renderFilteredDogs() {
    const keyword = searchInput.value.toLowerCase().trim();
    tableBody.innerHTML = "";

    const dogList = Object.entries(allDogs)
      .filter(([_, dog]) => {
        const combined = `${dog.name} ${dog.breed || ''} ${dog.trait || ''}`.toLowerCase();
        return combined.includes(keyword);
      })
      .sort(([_, a], [__, b]) => {
        if (a.status === 'play' && b.status !== 'play') return -1;
        if (a.status !== 'play' && b.status === 'play') return 1;
        return 0;
      });

    let total = 0, playing = 0;

    for (const [id, dog] of dogList) {
      const count = dogCounts[dog.name] || 0;
      total++;
      if (dog.status === 'play') playing++;
      tableBody.innerHTML += `
        <tr>
          <td data-label="·∫¢nh"><img src="${dog.image || '#'}" alt="${dog.name}"></td>
          <td data-label="T√™n">${dog.name}</td>
          <td data-label="Gi·ªëng">${dog.breed || 'Kh√¥ng r√µ'}</td>
          <td data-label="T√≠nh c√°ch">${dog.trait || 'Hi·ªÅn l√†nh'}</td>
          <td data-label="Tr·∫°ng th√°i">${dog.status === 'play' ? '‚òÄÔ∏è ƒêang ch∆°i' : 'üåô Ngh·ªâ ng∆°i'}</td>
          <td data-label="L∆∞·ª£t ch·ªçn">${count}</td>
          <td data-label="H√†nh ƒë·ªông">
            <button class="btn btn-sm ${dog.status === 'play' ? 'btn-secondary' : 'btn-success'}" onclick="toggleStatus('${id}', '${dog.status}')">
              ${dog.status === 'play' ? 'üåô Cho ngh·ªâ' : '‚òÄÔ∏è Xu·ªëng ch∆°i'}
            </button>
            <button class="btn btn-sm btn-warning" onclick="openForm('${id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteDog('${id}')">üóëÔ∏è</button>
          </td>
        </tr>`;
    }

    statusDisplay.innerHTML = `üêæ ƒêang th·∫£ <strong>${playing}</strong> / T·ªïng <strong>${total}</strong> b√©`;
  }

  function toggleStatus(id, status) {
    const newStatus = status === "play" ? "rest" : "play";
    db.ref("dogs/" + id).update({ status: newStatus });
  }

  function openForm(id = "") {
    document.getElementById("dog-id").value = id;
    if (id && allDogs[id]) {
      const d = allDogs[id];
      document.getElementById("form-title").innerText = "S·ª≠a th√¥ng tin ch√≥";
      document.getElementById("dog-name").value = d.name;
      document.getElementById("dog-breed").value = d.breed;
      document.getElementById("dog-trait").value = d.trait || "";
      document.getElementById("dog-image").value = d.image;
    } else {
      document.getElementById("form-title").innerText = "Th√™m ch√≥ m·ªõi";
      document.getElementById("dog-name").value = "";
      document.getElementById("dog-breed").value = "";
      document.getElementById("dog-trait").value = "";
      document.getElementById("dog-image").value = "";
    }
    dogModal.show();
  }

  function submitDog() {
    const id = document.getElementById("dog-id").value;
    const name = document.getElementById("dog-name").value;
    const breed = document.getElementById("dog-breed").value;
    const trait = document.getElementById("dog-trait").value;
    const image = document.getElementById("dog-image").value;
    const data = { name, breed, trait, image, status: "rest" };
    if (id) db.ref("dogs/" + id).update(data);
    else db.ref("dogs").push(data);
    dogModal.hide();
    Swal.fire({ icon: 'success', title: 'ƒê√£ l∆∞u th√¥ng tin ch√≥!', timer: 1500, showConfirmButton: false });
  }

  function deleteDog(id) {
    Swal.fire({
      title: 'X√°c nh·∫≠n xo√°?',
      text: "B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ch√∫ ch√≥ n√†y?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Xo√°'
    }).then((result) => {
      if (result.isConfirmed) {
        db.ref("dogs/" + id).remove();
        Swal.fire({ icon: 'success', title: 'ƒê√£ xo√°!', timer: 1000, showConfirmButton: false });
      }
    });
  }

  function clearNotifications() {
    Swal.fire({
      title: 'X√°c nh·∫≠n?',
      text: "B·∫°n mu·ªën xo√° t·∫•t c·∫£ th√¥ng b√°o?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Xo√°',
      cancelButtonText: 'Hu·ª∑'
    }).then(result => {
      if (result.isConfirmed) {
        db.ref("photoRequests").remove();
        Swal.fire({ icon: 'success', title: 'ƒê√£ xo√° t·∫•t c·∫£!', timer: 1000, showConfirmButton: false });
      }
    });
  }

  function setAllToRest() {
    Swal.fire({
      title: 'Cho t·∫•t c·∫£ ngh·ªâ?',
      text: 'B·∫°n mu·ªën cho t·∫•t c·∫£ ch√≥ ngh·ªâ ng∆°i?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ƒê·ªìng √Ω'
    }).then(result => {
      if (result.isConfirmed) {
        const updates = {};
        for (const id in allDogs) {
          if (allDogs[id].status === "play") {
            updates[`dogs/${id}/status`] = "rest";
          }
        }
        db.ref().update(updates)
          .then(() => Swal.fire('‚úÖ ƒê√£ cho c√°c b√© ngh·ªâ!'))
          .catch(err => Swal.fire('‚ùå L·ªói', err.message, 'error'));
      }
    });
  }

  function formatTime(input) {
    const date = new Date(input);
    if (!isNaN(date.getTime())) {
      date.setUTCHours(date.getUTCHours() + 7);
      const h = date.getHours().toString().padStart(2, "0");
      const m = date.getMinutes().toString().padStart(2, "0");
      const d = date.getDate().toString().padStart(2, "0");
      const mo = (date.getMonth() + 1).toString().padStart(2, "0");
      return `${h}h${m}p - ${d}/${mo}`;
    }
    return input;
  }

  function loadNotifications() {
    db.ref("photoRequests").limitToLast(10).on("value", snapshot => {
      const data = snapshot.val();
      if (!data) return notificationBox.innerHTML = "üì• Ch∆∞a c√≥ th√¥ng b√°o n√†o.";
      const list = Object.values(data);
      const messages = list.map(item => {
        const names = Array.isArray(item.selectedDogs) ? item.selectedDogs.filter(Boolean) : item.dog ? [item.dog] : [];
        const timeText = formatTime(item.time || item.timestamp);
        const side = item.seat?.side || "";
        const table = item.seat?.table || "";
        const location = `${side}${table ? ` - ${table}` : ""}`;
        return names.length ? `üì∏ Kh√°ch ng·ªìi <strong>${location}</strong> v·ª´a ch·ªçn <strong>${names.join(", ")}</strong> l√∫c <strong>${timeText}</strong>` : null;
      }).filter(Boolean);
      notificationBox.innerHTML = messages.length > 0
        ? "üîî <strong>TH√îNG B√ÅO:</strong><br>" + messages.reverse().join("<br>‚Äî<br>")
        : "üì• Kh√¥ng c√≥ th√¥ng tin h·ª£p l·ªá ƒë·ªÉ hi·ªÉn th·ªã.";
    });
  }

  loadDogs();
  loadCounts();
  loadNotifications();
</script>

</body>
</html>
