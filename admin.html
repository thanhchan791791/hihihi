<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üê∂ Qu·∫£n l√Ω tr·∫°ng th√°i ch√≥</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-soft@5/soft.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(to bottom, #fffafc, #ffeef5);
      padding: 16px;
      margin: auto;
      max-width: 100%;
    }
    #statusDisplay {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(255, 245, 250, 0.95);
      backdrop-filter: blur(3px);
    }

    h1 {
      font-size: 1.8rem;
      color: #ff4d79;
      text-shadow: 1px 1px 1px #ffd6e8;
    }

    .status-box {
      background: linear-gradient(to right, #ffb3c6, #ffd6e8);
      border: 2px dashed #ff69b4;
      padding: 12px 20px;
      font-size: 1.2rem;
      color: #6b0033;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(255, 105, 180, 0.2);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.5); }
      70% { box-shadow: 0 0 0 10px rgba(255, 105, 180, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0); }
    }

    .table {
      border: 2px solid #ffc2d1;
      border-radius: 12px;
      background-color: #fff0f5;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
    }

    .table thead {
      background-color: #ffb3c6;
      color: #fff;
      font-weight: 600;
    }

    .table tbody tr {
      background-color: #fff5f7;
      transition: background 0.3s;
    }

    .table tbody tr:hover {
      background-color: #ffe0ea;
    }

    .table td, .table th {
      vertical-align: middle;
      border: 1px solid #ffc2d1;
    }

    table img {
      width: 80px;
      height: 64px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #ffc2d1;
    }

    .btn {
      border-radius: 20px;
      font-size: 0.9rem;
      padding: 6px 12px;
    }

    .modal-content {
      background-color: #fff0f5;
      border: 2px solid #ffd6e8;
      border-radius: 16px;
    }

    .form-control {
      border-radius: 12px;
      border: 1px solid #ffccd5;
    }

    .alert-info {
      background-color: #ffeef5;
      border: 1px solid #ffc2d1;
      color: #d63384;
      font-weight: 600;
    }

    .input-group-text.bg-pink {
      background-color: #ffc2d1;
      color: #fff;
      border: 1px solid #ffc2d1;
    }

    .input-group .form-control::placeholder {
      color: #d63384;
      font-style: italic;
    }

    .input-group .form-control {
      font-size: 1.1rem;
      font-weight: 500;
      background-color: #fff5f8;
    }

    @media (max-width: 768px) {
      .table thead {
        display: none;
      }

      .table tbody tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #ffc2d1;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: #fff;
        padding: 10px;
      }

      .table td {
        display: flex;
        justify-content: space-between;
        padding: 8px 10px;
        border: none;
        border-bottom: 1px solid #ffc2d1;
      }

      .table td:last-child {
        border-bottom: none;
      }

      .table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #d63384;
      }

      table img {
        width: 64px;
        height: 50px;
      }
    }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">üê∂ C·∫≠p nh·∫≠t tr·∫°ng th√°i ch√≥ üê∂</h1>

  <div class="alert alert-info" id="notification">üîî ƒêang t·∫£i th√¥ng b√°o...</div>

  <div class="status-box text-center fw-semibold mb-3" id="statusDisplay">
    üêæ ƒêang t·∫£i tr·∫°ng th√°i...
  </div>

  <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
    <button class="btn btn-danger" onclick="clearNotifications()">üóëÔ∏è X√≥a t·∫•t c·∫£ th√¥ng b√°o</button>
    <button class="btn btn-success" onclick="openForm()">‚ûï Th√™m ch√≥ m·ªõi</button>
    <button class="btn btn-warning" onclick="setAllToRest()">üåô Cho t·∫•t c·∫£ ngh·ªâ</button>
  </div>
<!-- N√∫t hi·ªán/·∫©n form upload -->
<div class="text-center mb-3">
  <button class="btn btn-outline-primary" onclick="toggleUploadPanel()">üì∏ Upload ·∫£nh kh√°ch</button>
</div>

<!-- Form upload ·∫£nh, m·∫∑c ƒë·ªãnh ·∫©n -->
<div id="uploadPanel" class="p-3 border rounded shadow" style="
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 500px;
  background-color: #fff0f5;
  z-index: 9999;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  border: 2px solid #ffc2d1;
  border-radius: 16px;
  opacity: 0;
  pointer-events: none;
  transition: all 0.4s ease;
">
  <button onclick="toggleUploadPanel()" class="btn-close position-absolute" style="top:10px; right:10px;"></button>

  <h4>üì∏ Upload nhi·ªÅu ·∫£nh kh√°ch</h4>

  <div class="form-group mb-3">
    <label for="fileInput">Ch·ªçn ·∫£nh:</label>
    <input type="file" id="fileInput" class="form-control" accept="image/*" multiple>
  </div>

  <div class="form-group mb-3">
    <label for="tenAnh">T√™n nh√≥m ·∫£nh (VD: khach1):</label>
    <input type="text" id="tenAnh" class="form-control" placeholder="Nh·∫≠p t√™n nh√≥m ·∫£nh">
  </div>

  <button class="btn btn-primary" onclick="uploadImages()">üì§ Upload v√† L∆∞u</button>

  <div id="uploadResult" class="mt-4"></div>
  <div id="uploadProgress" class="mt-2 text-center fw-bold text-danger"></div>

</div>


  <div class="input-group mb-4 shadow-lg" style="max-width: 500px; margin: auto; font-size: 1.2rem;">
    <span class="input-group-text bg-pink">
      <i class="fas fa-dog"></i>
    </span>
    <input type="text" id="searchInput" class="form-control py-2" placeholder="T√¨m theo t√™n b√© c√∫n..." oninput="renderFilteredDogs()">
  </div>
  <table class="table table-bordered table-hover text-center">
    <thead>
      <tr>
        <th>·∫¢nh</th>
        <th>T√™n</th>
        <th>Gi·ªëng</th>
        <th>T√≠nh c√°ch</th>
        <th>Tr·∫°ng th√°i</th>
        <th>L∆∞·ª£t ch·ªçn</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="dog-table-body"></tbody>
  </table>

  <!-- Modal -->
  <div class="modal fade" id="dogModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="form-title">Th√™m ch√≥</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="dog-id">
          <input type="text" id="dog-name" class="form-control mb-2" placeholder="T√™n">
          <input type="text" id="dog-breed" class="form-control mb-2" placeholder="Gi·ªëng">
          <input type="text" id="dog-trait" class="form-control mb-2" placeholder="T√≠nh c√°ch">
          <input type="text" id="dog-image" class="form-control mb-2" placeholder="Link ·∫£nh">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
          <button type="button" class="btn btn-primary" onclick="submitDog()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Bootstrap -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
    authDomain: "dogs-be72b.firebaseapp.com",
    databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
    projectId: "dogs-be72b",
    storageBucket: "dogs-be72b.appspot.com",
    messagingSenderId: "1003873040746",
    appId: "1:1003873040746:web:607f4ff587afc430d3cd13"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const tableBody = document.getElementById("dog-table-body");
  const searchInput = document.getElementById("searchInput");
  const notificationBox = document.getElementById("notification");
  const statusDisplay = document.getElementById("statusDisplay");
  const dogModal = new bootstrap.Modal(document.getElementById('dogModal'));
  let allDogs = {}, dogCounts = {};

  function loadDogs() {
    db.ref("dogs").on("value", snapshot => {
      allDogs = snapshot.val() || {};
      renderFilteredDogs();
    });
  }

  function loadCounts() {
    db.ref("photoRequests").on("value", snapshot => {
      const data = snapshot.val();
      const counts = {};
      if (data) {
        Object.values(data).forEach(item => {
          let selected = [];
          if (Array.isArray(item.selectedDogs)) {
            selected = item.selectedDogs;
          } else if (typeof item.dog === 'string') {
            selected = [item.dog];
          }

          selected
            .filter(name => typeof name === 'string' && name.trim() !== "")
            .forEach(name => {
              counts[name] = (counts[name] || 0) + 1;
            });
        });
      }
      dogCounts = counts;
      renderFilteredDogs();
    });
  }

  function renderFilteredDogs() {
    const keyword = searchInput.value.toLowerCase().trim();
    tableBody.innerHTML = "";

    const dogList = Object.entries(allDogs)
      .filter(([_, dog]) => {
        const combined = `${dog.name} ${dog.breed || ''} ${dog.trait || ''}`.toLowerCase();
        return combined.includes(keyword);
      })
      .sort(([_, a], [__, b]) => {
        if (a.status === 'play' && b.status !== 'play') return -1;
        if (a.status !== 'play' && b.status === 'play') return 1;
        return 0;
      });

       let total = Object.keys(allDogs).length;
    let playing = Object.values(allDogs).filter(d => d.status === 'play').length;

    for (const [id, dog] of dogList) {
      const count = dogCounts[dog.name] || 0;

      tableBody.innerHTML += `
        <tr>
          <td data-label="·∫¢nh"><img src="${dog.image || '#'}" alt="${dog.name}"></td>
          <td data-label="T√™n">${dog.name}</td>
          <td data-label="Gi·ªëng">${dog.breed || 'Kh√¥ng r√µ'}</td>
          <td data-label="T√≠nh c√°ch">${dog.trait || 'Hi·ªÅn l√†nh'}</td>
          <td data-label="Tr·∫°ng th√°i">${dog.status === 'play' ? '‚òÄÔ∏è ƒêang ch∆°i' : 'üåô Ngh·ªâ ng∆°i'}</td>
          <td data-label="L∆∞·ª£t ch·ªçn">${count}</td>
          <td data-label="H√†nh ƒë·ªông">
            <button class="btn btn-sm ${dog.status === 'play' ? 'btn-secondary' : 'btn-success'}" onclick="toggleStatus('${id}', '${dog.status}')">
              ${dog.status === 'play' ? 'üåô Cho ngh·ªâ' : '‚òÄÔ∏è Xu·ªëng ch∆°i'}
            </button>
            <button class="btn btn-sm btn-warning" onclick="openForm('${id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteDog('${id}')">üóëÔ∏è</button>
          </td>
        </tr>`;
    }

    statusDisplay.innerHTML = `üêæ ƒêang th·∫£ <strong>${playing}</strong> / T·ªïng <strong>${total}</strong> b√©`;
  }

  function toggleStatus(id, status) {
    const newStatus = status === "play" ? "rest" : "play";
    db.ref("dogs/" + id).update({ status: newStatus });
  }

  function openForm(id = "") {
    document.getElementById("dog-id").value = id;
    if (id && allDogs[id]) {
      const d = allDogs[id];
      document.getElementById("form-title").innerText = "S·ª≠a th√¥ng tin ch√≥";
      document.getElementById("dog-name").value = d.name;
      document.getElementById("dog-breed").value = d.breed;
      document.getElementById("dog-trait").value = d.trait || "";
      document.getElementById("dog-image").value = d.image;
    } else {
      document.getElementById("form-title").innerText = "Th√™m ch√≥ m·ªõi";
      document.getElementById("dog-name").value = "";
      document.getElementById("dog-breed").value = "";
      document.getElementById("dog-trait").value = "";
      document.getElementById("dog-image").value = "";
    }
    dogModal.show();
  }

  function submitDog() {
    const id = document.getElementById("dog-id").value;
    const name = document.getElementById("dog-name").value;
    const breed = document.getElementById("dog-breed").value;
    const trait = document.getElementById("dog-trait").value;
    const image = document.getElementById("dog-image").value;
    const data = { name, breed, trait, image, status: "rest" };
    if (id) db.ref("dogs/" + id).update(data);
    else db.ref("dogs").push(data);
    dogModal.hide();
    Swal.fire({ icon: 'success', title: 'ƒê√£ l∆∞u th√¥ng tin ch√≥!', timer: 1500, showConfirmButton: false });
  }

  function deleteDog(id) {
    Swal.fire({
      title: 'X√°c nh·∫≠n xo√°?',
      text: "B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ch√∫ ch√≥ n√†y?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Xo√°'
    }).then((result) => {
      if (result.isConfirmed) {
        db.ref("dogs/" + id).remove();
        Swal.fire({ icon: 'success', title: 'ƒê√£ xo√°!', timer: 1000, showConfirmButton: false });
      }
    });
  }
let isUploadVisible = false;
function toggleUploadPanel() {
  const panel = document.getElementById("uploadPanel");

  if (isUploadVisible) {
    panel.style.opacity = "0";
    panel.style.pointerEvents = "none";
  } else {
    panel.style.opacity = "1";
    panel.style.pointerEvents = "auto";
  }

  isUploadVisible = !isUploadVisible;
}


  function clearNotifications() {
    Swal.fire({
      title: 'X√°c nh·∫≠n?',
      text: "B·∫°n mu·ªën xo√° t·∫•t c·∫£ th√¥ng b√°o?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Xo√°',
      cancelButtonText: 'Hu·ª∑'
    }).then(result => {
      if (result.isConfirmed) {
        db.ref("photoRequests").remove();
        Swal.fire({ icon: 'success', title: 'ƒê√£ xo√° t·∫•t c·∫£!', timer: 1000, showConfirmButton: false });
      }
    });
  }

  function setAllToRest() {
    Swal.fire({
      title: 'Cho t·∫•t c·∫£ ngh·ªâ?',
      text: 'B·∫°n mu·ªën cho t·∫•t c·∫£ ch√≥ ngh·ªâ ng∆°i?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ƒê·ªìng √Ω'
    }).then(result => {
      if (result.isConfirmed) {
        const updates = {};
        for (const id in allDogs) {
          if (allDogs[id].status === "play") {
            updates[`dogs/${id}/status`] = "rest";
          }
        }
        db.ref().update(updates)
          .then(() => Swal.fire('‚úÖ ƒê√£ cho c√°c b√© ngh·ªâ!'))
          .catch(err => Swal.fire('‚ùå L·ªói', err.message, 'error'));
      }
    });
  }

  function formatTime(input) {
    const date = new Date(input);
    if (!isNaN(date.getTime())) {
      date.setUTCHours(date.getUTCHours() + 7);
      const h = date.getHours().toString().padStart(2, "0");
      const m = date.getMinutes().toString().padStart(2, "0");
      const d = date.getDate().toString().padStart(2, "0");
      const mo = (date.getMonth() + 1).toString().padStart(2, "0");
      return `${h}h${m}p - ${d}/${mo}`;
    }
    return input;
  }

  function loadNotifications() {
    db.ref("photoRequests").limitToLast(10).on("value", snapshot => {
      const data = snapshot.val();
      if (!data) return notificationBox.innerHTML = "üì• Ch∆∞a c√≥ th√¥ng b√°o n√†o.";
      const list = Object.values(data);
      const messages = list.map(item => {
        const names = Array.isArray(item.selectedDogs) ? item.selectedDogs.filter(Boolean) : item.dog ? [item.dog] : [];
        const timeText = formatTime(item.time || item.timestamp);
        const side = item.seat?.side || "";
        const table = item.seat?.table || "";
        const location = `${side}${table ? ` - ${table}` : ""}`;
        return names.length ? `üì∏ Kh√°ch ng·ªìi <strong>${location}</strong> v·ª´a ch·ªçn <strong>${names.join(", ")}</strong> l√∫c <strong>${timeText}</strong>` : null;
      }).filter(Boolean);
      notificationBox.innerHTML = messages.length > 0
        ? "üîî <strong>TH√îNG B√ÅO:</strong><br>" + messages.reverse().join("<br>‚Äî<br>")
        : "üì• Kh√¥ng c√≥ th√¥ng tin h·ª£p l·ªá ƒë·ªÉ hi·ªÉn th·ªã.";
    });
  }
function compressImageToWebP(file) {
  return new Promise((resolve) => {
    new Compressor(file, {
      quality: 0.6,
      convertTypes: ['image/webp'],
      mimeType: 'image/webp',
      success(result) {
        resolve(result);
      },
      error(err) {
        console.warn("‚ùå L·ªói n√©n ·∫£nh:", err);
        resolve(file); // fallback n·∫øu n√©n l·ªói
      }
    });
  });
}

async function uploadImages() {
  const files = document.getElementById("fileInput").files;
  const ten = document.getElementById("tenAnh").value.trim().toLowerCase();
  const apiKey = "b5107933ec7b5e31a4bb280bf121e183";

  const resultBox = document.getElementById("uploadResult");
  const progressBox = document.getElementById("uploadProgress");

  if (files.length === 0 || !ten) {
    Swal.fire("‚ö†Ô∏è Thi·∫øu th√¥ng tin", "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ·∫£nh v√† nh·∫≠p t√™n nh√≥m!", "warning");
    return;
  }

  resultBox.innerHTML = "<p>‚è≥ ƒêang n√©n v√† upload ·∫£nh...</p>";
  progressBox.innerText = "0%";

  const uploadTasks = [...files].map(async (file, index) => {
    try {
      const compressed = await compressImageToWebP(file);

      const formData = new FormData();
      formData.append("image", compressed);

      const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.success) {
        return `<div class="swiper-slide"><img src="${data.data.url}" alt="·∫¢nh ${index + 1}" onclick="toggleZoom(this)" /></div>`;
      } else {
        console.warn(`‚ùå ·∫¢nh ${index + 1} upload th·∫•t b·∫°i`);
        return "";
      }
    } catch (err) {
      console.error("‚ùå L·ªói x·ª≠ l√Ω ·∫£nh:", err);
      return "";
    } finally {
      const percent = Math.round(((index + 1) / files.length) * 100);
      progressBox.innerText = `${percent}%`;
    }
  });

  const results = await Promise.all(uploadTasks);
  const htmlSlides = results.filter(Boolean).join("");
  const successCount = results.filter(Boolean).length;

  if (successCount > 0) {
    await firebase.database().ref("anhKhachHtml/" + ten).set(htmlSlides);

    Swal.fire({
      icon: 'success',
      title: `‚úÖ ƒê√£ upload ${successCount} ·∫£nh`,
      text: `ƒê√£ l∆∞u nh√≥m: ${ten}`,
      showConfirmButton: false,
      timer: 2000
    });

    toggleUploadPanel();
    document.getElementById("fileInput").value = "";
    document.getElementById("tenAnh").value = "";
    progressBox.innerText = "";
    resultBox.innerHTML = "";
  } else {
    resultBox.innerHTML = "<p style='color:red;'>‚ùå Kh√¥ng upload ƒë∆∞·ª£c ·∫£nh n√†o!</p>";
  }
}

  loadDogs();
  loadCounts();
  loadNotifications();
</script>

</body>
</html>
