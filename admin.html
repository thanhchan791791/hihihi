<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸ¶ Quáº£n lÃ½ tráº¡ng thÃ¡i chÃ³</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-soft@5/soft.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(to bottom, #fffafc, #ffeef5);
      padding: 16px;
      max-width: 100%;
      margin: auto;
    }
    h1 {
      font-size: 1.8rem;
      color: #ff4d79;
      text-shadow: 1px 1px 1px #ffd6e8;
    }
    .table {
      border: 2px solid #ffc2d1;
      border-radius: 12px;
      background-color: #fff0f5;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
    }
    .table thead {
      background-color: #ffb3c6;
      color: #fff;
      font-weight: 600;
    }
    .table tbody tr {
      background-color: #fff5f7;
      transition: background 0.3s;
    }
    .table tbody tr:hover {
      background-color: #ffe0ea;
    }
    .table td, .table th {
      vertical-align: middle;
      border: 1px solid #ffc2d1;
    }
    table img {
      width: 80px;
      height: 64px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #ffc2d1;
    }
    .btn {
      border-radius: 20px;
      font-size: 0.9rem;
      padding: 6px 12px;
    }
    .modal-content {
      background-color: #fff0f5;
      border: 2px solid #ffd6e8;
      border-radius: 16px;
    }
    .form-control {
      border-radius: 12px;
      border: 1px solid #ffccd5;
    }
    .alert-info {
      background-color: #ffeef5;
      border: 1px solid #ffc2d1;
      color: #d63384;
      font-weight: 600;
    }
    .input-group-text.bg-pink {
      background-color: #ffc2d1;
      color: #fff;
      border: 1px solid #ffc2d1;
    }
    .input-group .form-control::placeholder {
      color: #d63384;
      font-style: italic;
    }
    .input-group .form-control {
      font-size: 1.1rem;
      font-weight: 500;
      background-color: #fff5f8;
    }
    @media (max-width: 576px) {
      h1 {
        font-size: 1.5rem;
      }
      .table td, .table th {
        font-size: 0.75rem;
        padding: 6px;
      }
      .btn {
        font-size: 0.75rem;
        padding: 4px 8px;
      }
      table img {
        width: 60px;
        height: 50px;
      }
      .input-group-text {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">ğŸ¶ Cáº­p nháº­t tráº¡ng thÃ¡i chÃ³ ğŸ¶</h1>

  <div class="alert alert-info" id="notification">ğŸ”” Äang táº£i thÃ´ng bÃ¡o...</div>

  <div class="d-flex justify-content-center gap-2 mb-3">
    <button class="btn btn-danger" onclick="clearNotifications()">ğŸ—‘ï¸ XÃ³a táº¥t cáº£ thÃ´ng bÃ¡o</button>
    <button class="btn btn-success" onclick="openForm()">â• ThÃªm chÃ³ má»›i</button>
    <button class="btn btn-warning" onclick="setAllToRest()">ğŸŒ™ Cho táº¥t cáº£ nghá»‰</button>
  </div>

  <!-- ğŸ” Thanh tÃ¬m kiáº¿m to hÆ¡n, chuyÃªn nghiá»‡p hÆ¡n -->
  <div class="input-group mb-4 shadow-lg" style="max-width: 500px; margin: auto; font-size: 1.2rem;">
    <span class="input-group-text bg-pink">
      <i class="fas fa-dog"></i>
    </span>
    <input type="text" id="searchInput" class="form-control py-2" placeholder="TÃ¬m theo tÃªn bÃ© cÃºn..." oninput="renderFilteredDogs()">
  </div>

  <table class="table table-bordered table-hover text-center">
    <thead>
      <tr>
        <th>áº¢nh</th>
        <th>TÃªn</th>
        <th>Giá»‘ng</th>
        <th>Tráº¡ng thÃ¡i</th>
        <th>LÆ°á»£t chá»n</th>
        <th>HÃ nh Ä‘á»™ng</th>
      </tr>
    </thead>
    <tbody id="dog-table-body"></tbody>
  </table>

  <!-- Modal thÃªm/sá»­a -->
  <div class="modal fade" id="dogModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="form-title">ThÃªm chÃ³</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="dog-id">
          <input type="text" id="dog-name" class="form-control mb-2" placeholder="TÃªn">
          <input type="text" id="dog-breed" class="form-control mb-2" placeholder="Giá»‘ng">
          <input type="text" id="dog-image" class="form-control mb-2" placeholder="Link áº£nh">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huá»·</button>
          <button type="button" class="btn btn-primary" onclick="submitDog()">LÆ°u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase config + logic -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBNB1acbPtKox8eTjth3FtWuDOLhueRIys",
      authDomain: "dogs-be72b.firebaseapp.com",
      databaseURL: "https://dogs-be72b-default-rtdb.firebaseio.com",
      projectId: "dogs-be72b",
      storageBucket: "dogs-be72b.appspot.com",
      messagingSenderId: "1003873040746",
      appId: "1:1003873040746:web:607f4ff587afc430d3cd13"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tableBody = document.getElementById("dog-table-body");
    const searchInput = document.getElementById("searchInput");
    const notificationBox = document.getElementById("notification");

    const dogModal = new bootstrap.Modal(document.getElementById('dogModal'));
    let allDogs = {}, dogCounts = {};

    function loadDogs() {
      db.ref("dogs").on("value", snapshot => {
        allDogs = snapshot.val() || {};
        renderFilteredDogs();
      });
    }

    function loadCounts() {
      db.ref("photoRequests").on("value", snapshot => {
        dogCounts = {};
        const data = snapshot.val();
        if (!data) return;
        Object.values(data).forEach(item => {
          const selected = Array.isArray(item.selectedDogs) ? item.selectedDogs : item.dog ? [item.dog] : [];
          selected.forEach(name => {
            if (!name) return;
            dogCounts[name] = (dogCounts[name] || 0) + 1;
          });
        });
        renderFilteredDogs();
      });
    }

    function renderFilteredDogs() {
      const keyword = searchInput.value.toLowerCase().trim();
      tableBody.innerHTML = "";
      for (const id in allDogs) {
        const dog = allDogs[id];
        if (!dog.name.toLowerCase().includes(keyword)) continue;
        const count = dogCounts[dog.name] || 0;
        tableBody.innerHTML += `
          <tr>
            <td><img src="${dog.image || '#'}" alt="${dog.name}"></td>
            <td>${dog.name}</td>
            <td>${dog.breed || 'KhÃ´ng rÃµ'}</td>
            <td>${dog.status === 'play' ? 'â˜€ï¸ Äang chÆ¡i' : 'ğŸŒ™ Nghá»‰ ngÆ¡i'}</td>
            <td>${count}</td>
            <td>
              <button class="btn btn-sm ${dog.status === 'play' ? 'btn-secondary' : 'btn-success'}" onclick="toggleStatus('${id}', '${dog.status}')">
                ${dog.status === 'play' ? 'ğŸŒ™ Cho nghá»‰' : 'â˜€ï¸ Xuá»‘ng chÆ¡i'}
              </button>
              <button class="btn btn-sm btn-warning" onclick="openForm('${id}')">âœï¸</button>
              <button class="btn btn-sm btn-danger" onclick="deleteDog('${id}')">ğŸ—‘ï¸</button>
            </td>
          </tr>`;
      }
    }

    function toggleStatus(id, status) {
      const newStatus = status === "play" ? "rest" : "play";
      db.ref("dogs/" + id).update({ status: newStatus });
    }

    function openForm(id = "") {
      document.getElementById("dog-id").value = id;
      if (id && allDogs[id]) {
        const d = allDogs[id];
        document.getElementById("form-title").innerText = "Sá»­a thÃ´ng tin chÃ³";
        document.getElementById("dog-name").value = d.name;
        document.getElementById("dog-breed").value = d.breed;
        document.getElementById("dog-image").value = d.image;
      } else {
        document.getElementById("form-title").innerText = "ThÃªm chÃ³ má»›i";
        document.getElementById("dog-name").value = "";
        document.getElementById("dog-breed").value = "";
        document.getElementById("dog-image").value = "";
      }
      dogModal.show();
    }

    function submitDog() {
      const id = document.getElementById("dog-id").value;
      const name = document.getElementById("dog-name").value;
      const breed = document.getElementById("dog-breed").value;
      const image = document.getElementById("dog-image").value;
      const data = { name, breed, image, status: "rest" };
      if (id) db.ref("dogs/" + id).update(data);
      else db.ref("dogs").push(data);
      dogModal.hide();
      Swal.fire({ icon: 'success', title: 'ÄÃ£ lÆ°u thÃ´ng tin chÃ³!', timer: 1500, showConfirmButton: false });
    }

    function deleteDog(id) {
      Swal.fire({
        title: 'XÃ¡c nháº­n xoÃ¡?',
        text: "Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ chÃº chÃ³ nÃ y?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'XoÃ¡'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref("dogs/" + id).remove();
          Swal.fire({ icon: 'success', title: 'ÄÃ£ xoÃ¡!', timer: 1000, showConfirmButton: false });
        }
      });
    }

    function clearNotifications() {
      Swal.fire({
        title: 'XÃ¡c nháº­n?',
        text: "Báº¡n muá»‘n xoÃ¡ táº¥t cáº£ thÃ´ng bÃ¡o?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'XoÃ¡',
        cancelButtonText: 'Huá»·'
      }).then(result => {
        if (result.isConfirmed) {
          db.ref("photoRequests").remove();
          Swal.fire({ icon: 'success', title: 'ÄÃ£ xoÃ¡ táº¥t cáº£!', timer: 1000, showConfirmButton: false });
        }
      });
    }

    function setAllToRest() {
      Swal.fire({
        title: 'Cho táº¥t cáº£ nghá»‰?',
        text: 'Báº¡n muá»‘n cho táº¥t cáº£ chÃ³ nghá»‰ ngÆ¡i?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Äá»“ng Ã½'
      }).then(result => {
        if (result.isConfirmed) {
          const updates = {};
          for (const id in allDogs) {
            if (allDogs[id].status === "play") {
              updates[`dogs/${id}/status`] = "rest";
            }
          }
          db.ref().update(updates)
            .then(() => Swal.fire('âœ… ÄÃ£ cho cÃ¡c bÃ© nghá»‰!'))
            .catch(err => Swal.fire('âŒ Lá»—i', err.message, 'error'));
        }
      });
    }

    function formatTime(input) {
      const date = new Date(input);
      if (!isNaN(date.getTime())) {
        date.setUTCHours(date.getUTCHours() + 7);
        const h = date.getHours().toString().padStart(2, "0");
        const m = date.getMinutes().toString().padStart(2, "0");
        const d = date.getDate().toString().padStart(2, "0");
        const mo = (date.getMonth() + 1).toString().padStart(2, "0");
        return `${h}h${m}p - ${d}/${mo}`;
      }
      return input;
    }

    function loadNotifications() {
      db.ref("photoRequests").limitToLast(10).on("value", snapshot => {
        const data = snapshot.val();
        if (!data) return notificationBox.innerHTML = "ğŸ“¥ ChÆ°a cÃ³ thÃ´ng bÃ¡o nÃ o.";
        const list = Object.values(data);
        const messages = list.map(item => {
          const names = Array.isArray(item.selectedDogs) ? item.selectedDogs.filter(Boolean) : item.dog ? [item.dog] : [];
          const timeText = formatTime(item.time || item.timestamp);
          const side = item.seat?.side || "";
          const table = item.seat?.table || "";
          const location = `${side}${table ? ` - ${table}` : ""}`;
          return names.length ? `ğŸ“¸ KhÃ¡ch ngá»“i <strong>${location}</strong> vá»«a chá»n <strong>${names.join(", ")}</strong> lÃºc <strong>${timeText}</strong>` : null;
        }).filter(Boolean);
        notificationBox.innerHTML = messages.length > 0 ? "ğŸ”” <strong>THÃ”NG BÃO:</strong><br>" + messages.reverse().join("<br>â€”<br>") : "ğŸ“¥ KhÃ´ng cÃ³ thÃ´ng tin há»£p lá»‡ Ä‘á»ƒ hiá»ƒn thá»‹.";
      });
    }

    loadDogs();
    loadCounts();
    loadNotifications();
  </script>
</body>
</html>
